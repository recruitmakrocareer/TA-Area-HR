<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HR Recruitment Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .status-select {
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat; background-position: right 0.4rem center; background-size: 1em; padding-right: 1.6rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';
    import { Users, UserPlus, BarChart3, Building2, CheckCircle2, Clock, MapPin, Search, AlertCircle, FileText, Briefcase, Phone, MessageSquare, Map, Target, Edit, Trash2, X, BellRing, Download, Paperclip, Upload, Eye, PlusCircle, Settings, Check } from 'https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0';

    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzM4EXsW141-nqY7rRwU_MFc9vnrJSbK-8Wdwn-ZJwvfEBlNMZJH2dhE0r2C4uJf7mnxg/exec"; 

    const DEFAULT_TAS = ['TA 1 (คุณเอ)', 'TA 2 (คุณบี)', 'TA 3 (คุณซี)', 'TA 4 (คุณดี)'];
    const DEFAULT_POSITIONS = [
      { position: 'ผู้จัดการสาขา', recruit: '', area: '' },
      { position: 'ผู้ช่วยผู้จัดการสาขา', recruit: '', area: '' },
      { position: 'พนักงานขาย', recruit: '', area: '' },
      { position: 'พนักงานแคชเชียร์', recruit: '', area: '' }
    ];

    const DEFAULT_BRANCHES = [
      { code: '001', name: 'สาขาลาดพร้าว', area: 'Area 5' },
      { code: '002', name: 'สาขาแจ้งวัฒนะ', area: 'Area 10' },
      { code: '003', name: 'สาขาศรีนครินทร์', area: 'Area 11' },
      { code: '004', name: 'สาขาบางบอน', area: 'Area 1' }
    ];

    // เพิ่ม "รอพิจารณาประวัติ" เข้าไปในลิสต์
    const STATUSES = ['รอพิจารณาประวัติ', 'รอสัมภาษณ์', 'ไม่เข้าสัมภาษณ์', 'ผ่าน', 'ไม่ผ่าน', 'สำรอง', 'ตรวจสุขภาพ', 'รอเริ่มงาน', 'มาเริ่มงาน', 'ไม่มาเริ่มงาน', 'อื่นๆ'];
    const VACANCY_STATUSES = ['Vacant', 'Promote&Transfer', 'Hold', 'Closed'];

    // เพิ่มสีให้ "รอพิจารณาประวัติ"
    const STATUS_COLORS = { 'รอพิจารณาประวัติ': '#06B6D4', 'รอสัมภาษณ์': '#F59E0B', 'ไม่เข้าสัมภาษณ์': '#64748B', 'ผ่าน': '#10B981', 'ไม่ผ่าน': '#EF4444', 'สำรอง': '#3B82F6', 'ตรวจสุขภาพ': '#8B5CF6', 'รอเริ่มงาน': '#0EA5E9', 'มาเริ่มงาน': '#059669', 'ไม่มาเริ่มงาน': '#94A3B8', 'อื่นๆ': '#F97316' };
    const VACANCY_COLORS = { 'Vacant': '#F59E0B', 'Promote&Transfer': '#8B5CF6', 'Hold': '#64748B', 'Closed': '#94A3B8', 'รอตรวจสุขภาพ': '#0EA5E9', 'รอเริ่มงาน': '#0EA5E9', 'Hiring': '#10B981' };

    const parseDateToMs = (val) => {
      if (!val) return null;
      let cleanStr = String(val).replace(/,/g, '').trim();
      let num = Number(cleanStr);
      if (!isNaN(num) && num > 1000000000000) return num;
      if (!isNaN(num) && num > 30000 && num < 100000) return new Date(Math.round((num - 25569) * 86400 * 1000)).getTime();
      let d = new Date(val);
      if (!isNaN(d.getTime())) return d.getTime();
      if (typeof val === 'string' && (val.includes('/') || val.includes('-'))) {
        let datePart = val.split(' ')[0];
        let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');
        if (parts.length >= 2) {
          let p1 = parseInt(parts[0], 10);
          let p2 = parseInt(parts[1], 10);
          let p3 = parts.length === 3 ? parseInt(parts[2], 10) : new Date().getFullYear();
          let day = p1, month = p2 - 1, year = p3;
          if (p1 > 1000) { year = p1; month = p2 - 1; day = parts.length === 3 ? parseInt(parts[2], 10) : 1; }
          if (year > 2500) year -= 543; 
          if (year >= 2000) { 
             let d2 = new Date(year, month, day);
             if (!isNaN(d2.getTime())) return d2.getTime();
          }
        }
      }
      return null;
    };

    const getConsistentTimestamp = () => {
      const d = new Date();
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hrs = String(d.getHours()).padStart(2, '0');
      const mins = String(d.getMinutes()).padStart(2, '0');
      const secs = String(d.getSeconds()).padStart(2, '0');
      return `${day}/${month}/${year} ${hrs}:${mins}:${secs}`;
    };

    function App() {
      const [activeTab, setActiveTab] = useState('area_hr');
      const [isLoading, setIsLoading] = useState(true); 
      const [cloudStatus, setCloudStatus] = useState('loading'); 
      const [appBranches, setAppBranches] = useState([]);
      const [appAreas, setAppAreas] = useState([]);
      const [appTAs, setAppTAs] = useState([]);
      const [appPositions, setAppPositions] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [selectedTA, setSelectedTA] = useState('');
      const [recruitAreaFilter, setRecruitAreaFilter] = useState('');
      const [recruitBranchFilter, setRecruitBranchFilter] = useState('');
      const [addingApplicantFor, setAddingApplicantFor] = useState(null);
      const [formData, setFormData] = useState({ name: '', phone: '', status: '', comment: '', startDate: '', resumeName: '', resumeBase64: '' });
      const [applicants, setApplicants] = useState([]);
      const [editAppId, setEditAppId] = useState(null);
      const [editAppForm, setEditAppForm] = useState({});
      const [previewFile, setPreviewFile] = useState(null);
      const [selectedAreas, setSelectedAreas] = useState([]);
      const [vacancyForm, setVacancyForm] = useState({ branchCode: '', position: '', manualStatus: 'Vacant' });
      const [viewApplicants, setViewApplicants] = useState(null);
      const [vacancies, setVacancies] = useState([]);
      const [editVacId, setEditVacId] = useState(null);
      const [editVacForm, setEditVacForm] = useState({});
      const [dashboardTA, setDashboardTA] = useState('ALL');

      const uniquePositionNames = useMemo(() => [...new Set(appPositions.map(p => p.position))], [appPositions]);

      useEffect(() => {
        const normalizePositions = (positions) => {
          return positions.map(p => {
            if (typeof p === 'string') return { position: p, recruit: '', area: '' };
            return { 
              position: String(p.position || p.name || '').trim(), 
              recruit: String(p.recruit || '').trim(),
              area: String(p.area || '').trim() 
            };
          });
        };

        const initLoad = async () => {
          setIsLoading(true);
          setCloudStatus('loading');
          let isCloudSuccess = false;
          let loadedApps = [];
          let loadedVacs = [];

          try {
            if (GOOGLE_SCRIPT_URL) {
              const res = await fetch(`${GOOGLE_SCRIPT_URL}?t=${new Date().getTime()}`);
              const data = await res.json();
              isCloudSuccess = true;
              setCloudStatus('connected');
              
              if (data.applicants) loadedApps = data.applicants.map(a => ({...a, id: String(a.id), branchCode: String(a.branchCode).padStart(3, '0')}));
              if (data.vacancies) loadedVacs = data.vacancies.map(v => ({...v, id: String(v.id), branchCode: String(v.branchCode).padStart(3, '0')}));
              if (data.branches && data.branches.length > 0) setAppBranches(data.branches.map(b => ({...b, code: String(b.code).padStart(3, '0')})));
              else setAppBranches(DEFAULT_BRANCHES);
              if (data.tas && data.tas.length > 0) setAppTAs(data.tas.map(t => String(t.name || t)));
              else setAppTAs(DEFAULT_TAS);
              if (data.positions && data.positions.length > 0) setAppPositions(normalizePositions(data.positions));
              else setAppPositions(DEFAULT_POSITIONS);
            }
          } catch (e) {
            console.error("ดึงข้อมูลจาก Cloud ไม่สำเร็จ", e);
            setCloudStatus('error');
            let localApps = localStorage.getItem('hr_applicants');
            let localVacs = localStorage.getItem('hr_vacancies');
            if (localApps) loadedApps = JSON.parse(localApps);
            if (localVacs) loadedVacs = JSON.parse(localVacs);
            const localBranches = localStorage.getItem('hr_branches');
            if (localBranches) { try { setAppBranches(JSON.parse(localBranches)); } catch(err) {} }
            else setAppBranches(DEFAULT_BRANCHES);
            const localTAs = localStorage.getItem('hr_tas');
            if (localTAs) { try { setAppTAs(JSON.parse(localTAs)); } catch(e) {} }
            else setAppTAs(DEFAULT_TAS);
            const localPositions = localStorage.getItem('hr_positions');
            if (localPositions) { try { setAppPositions(normalizePositions(JSON.parse(localPositions))); } catch(e) {} }
            else setAppPositions(DEFAULT_POSITIONS);
          }

          let needsAutoSync = false;
          const today = new Date();
          today.setHours(0,0,0,0);
          
          loadedApps = loadedApps.map(a => {
            if (a.status === 'รอเริ่มงาน' && a.startDate) {
              const sDate = new Date(a.startDate);
              sDate.setHours(0,0,0,0);
              if (sDate <= today) {
                needsAutoSync = true;
                return { ...a, status: 'มาเริ่มงาน' };
              }
            }
            return a;
          });

          setApplicants(loadedApps);
          setVacancies(loadedVacs);
          setIsLoading(false);

          if (needsAutoSync && isCloudSuccess) {
            syncToCloud(loadedApps, loadedVacs, true);
          }
        };
        initLoad();
      }, []);

      useEffect(() => {
        if (appBranches.length > 0) {
          const uniqueAreas = [...new Set(appBranches.map(b => String(b.area)))].sort((a,b) => {
            const numA = parseInt(a.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.replace(/\D/g, '')) || 0;
            return numA - numB;
          });
          setAppAreas(uniqueAreas);
        }
      }, [appBranches]);

      const syncToCloud = async (newApps, newVacs, forceSync = false) => {
        localStorage.setItem('hr_applicants', JSON.stringify(newApps));
        localStorage.setItem('hr_vacancies', JSON.stringify(newVacs));
        const isSafeToSync = forceSync || cloudStatus === 'connected' || cloudStatus === 'syncing';
        if (!isSafeToSync) {
            alert('⚠️ คุณอยู่ใน "โหมดออฟไลน์" ระบบจะบันทึกในเครื่องเท่านั้น ไม่ส่งขึ้นระบบกลางป้องกันการลบทับ');
            return;
        }
        if (GOOGLE_SCRIPT_URL) {
          try {
            setCloudStatus('syncing');
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'saveAll', applicants: newApps, vacancies: newVacs })
            });
            setTimeout(() => setCloudStatus('connected'), 1000);
          } catch (error) { setCloudStatus('error'); }
        }
      };

      const syncMasterToCloud = async (newBranches, newTAs, newPositions) => {
        if (cloudStatus === 'error') { alert('❌ ออฟไลน์อยู่ อัปเดต Master ไม่ได้'); return; }
        setIsLoading(true); setCloudStatus('syncing');
        if (GOOGLE_SCRIPT_URL) {
          try {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'updateMaster', branches: newBranches, tas: newTAs.map(name => ({name})), positions: newPositions })
            });
            setCloudStatus('connected'); alert('อัปเดต Master Data สำเร็จ!');
          } catch (error) { setCloudStatus('error'); alert('อัปเดตไม่สำเร็จ ตรวจสอบอินเทอร์เน็ต'); }
        }
        setIsLoading(false);
      };

      const handleImportCSV = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const wb = XLSX.read(evt.target.result, { type: 'binary' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
            const newBranches = [];
            for (let i = 1; i < data.length; i++) {
              if (data[i] && data[i][0] && data[i][1] && data[i][2]) {
                newBranches.push({ code: String(data[i][0]).padStart(3, '0'), name: String(data[i][1]).replace(/\n|\r/g, '').trim(), area: String(data[i][2]).replace(/\r/g, '').trim() });
              }
            }
            if (newBranches.length > 0) {
              setAppBranches(newBranches); localStorage.setItem('hr_branches', JSON.stringify(newBranches));
              syncMasterToCloud(newBranches, appTAs, appPositions);
            } else alert('ไม่พบข้อมูล หรือรูปแบบคอลัมน์ไม่ถูกต้อง');
          } catch (err) { alert('เกิดข้อผิดพลาดในการอ่านไฟล์'); }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportPositionCSV = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const wb = XLSX.read(evt.target.result, { type: 'binary' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
            const newPositions = []; const newTAsSet = new Set(appTAs); let foundNewTA = false;
            for (let i = 1; i < data.length; i++) {
              if (data[i] && data[i][0]) {
                const posName = String(data[i][0]).replace(/\r/g, '').trim();
                const recruitName = data[i][1] ? String(data[i][1]).replace(/\r/g, '').trim() : '';
                const areaName = data[i][2] ? String(data[i][2]).replace(/\r/g, '').trim() : '';
                if (posName) {
                  newPositions.push({ position: posName, recruit: recruitName, area: areaName });
                  if (recruitName && !newTAsSet.has(recruitName)) { newTAsSet.add(recruitName); foundNewTA = true; }
                }
              }
            }
            if (newPositions.length > 0) {
              setAppPositions(newPositions); localStorage.setItem('hr_positions', JSON.stringify(newPositions));
              const updatedTAs = Array.from(newTAsSet);
              if (foundNewTA) { setAppTAs(updatedTAs); localStorage.setItem('hr_tas', JSON.stringify(updatedTAs)); }
              syncMasterToCloud(appBranches, updatedTAs, newPositions);
              alert(`อัปเดตสำเร็จ! ตำแหน่งทั้งหมด ${newPositions.length} รายการ`);
            } else alert('ไม่พบข้อมูลตำแหน่งในคอลัมน์แรก');
          } catch (err) { alert('เกิดข้อผิดพลาดในการอ่านไฟล์'); }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportTACSV = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const wb = XLSX.read(bstr, { type: 'binary' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
            const newTAs = [];
            for (let i = 1; i < data.length; i++) {
              if (data[i] && data[i][0]) newTAs.push(String(data[i][0]).replace(/\r/g, '').trim());
            }
            if (newTAs.length > 0) {
              setAppTAs(newTAs); localStorage.setItem('hr_tas', JSON.stringify(newTAs));
              syncMasterToCloud(appBranches, newTAs, appPositions);
            } else alert('ไม่พบข้อมูล TA');
          } catch (err) { alert('ข้อผิดพลาดในการอ่านไฟล์'); }
        };
        reader.readAsBinaryString(file);
      };

      const exportToExcel = (dataList, filename) => {
        const ws = XLSX.utils.json_to_sheet(dataList);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, `${filename}.xlsx`);
      };

      const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
      
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => setFormData(prev => ({ ...prev, resumeBase64: reader.result, resumeName: file.name }));
          reader.readAsDataURL(file);
        }
      };
      
      const handleRecruitSubmit = async (e) => {
        e.preventDefault();
        if (!selectedTA || !addingApplicantFor) return;
        if (formData.status === 'รอเริ่มงาน' && !formData.startDate) { alert('กรุณาระบุวันที่เริ่มงาน'); return; }
        
        const newRecord = { 
          id: Date.now().toString(), ta: selectedTA, branchCode: String(addingApplicantFor.branchCode).padStart(3, '0'), 
          branchName: addingApplicantFor.branchName, position: addingApplicantFor.position, ...formData, 
          timestamp: getConsistentTimestamp(), updatedAt: Date.now() 
        };
        const newApps = [newRecord, ...applicants];
        setApplicants(newApps);
        setFormData({ name: '', phone: '', status: '', comment: '', startDate: '', resumeName: '', resumeBase64: '' });
        setAddingApplicantFor(null); syncToCloud(newApps, vacancies);
      };

      const deleteApplicant = (id) => {
        if (window.confirm('ลบข้อมูลผู้สมัครรายนี้?')) {
          const newApps = applicants.filter(a => String(a.id) !== String(id));
          setApplicants(newApps); syncToCloud(newApps, vacancies);
        }
      };

      const startEditApp = (app) => { setEditAppId(app.id); setEditAppForm({ ...app }); };
      const saveEditApp = () => {
        if (['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(editAppForm.status) && !editAppForm.comment) { alert('กรุณาระบุเหตุผล'); return; }
        if (editAppForm.status === 'รอเริ่มงาน' && !editAppForm.startDate) { alert('กรุณาระบุวันที่เริ่มงาน'); return; }
        if (!['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(editAppForm.status)) editAppForm.comment = '';
        
        const newApps = applicants.map(a => String(a.id) === String(editAppId) ? { ...editAppForm, updatedAt: Date.now() } : a);
        setApplicants(newApps); setEditAppId(null); syncToCloud(newApps, vacancies);
      };

      const handleInlineStatusChange = (app, newStatus) => {
        if (['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน', 'รอเริ่มงาน'].includes(newStatus)) {
          startEditApp({ ...app, status: newStatus });
        } else {
          const updatedApp = { ...app, status: newStatus, comment: '', startDate: '', updatedAt: Date.now() };
          const newApps = applicants.map(a => String(a.id) === String(app.id) ? updatedApp : a);
          setApplicants(newApps); syncToCloud(newApps, vacancies);
        }
      };

      const toggleArea = (area) => {
        setSelectedAreas(prev => prev.includes(area) ? prev.filter(a => a !== area) : [...prev, area]);
        setVacancyForm(prev => ({...prev, branchCode: ''}));
      };
      
      const handleVacancyInputChange = (e) => setVacancyForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
      const handleVacancySubmit = (e) => {
        e.preventDefault();
        const branch = appBranches.find(b => String(b.code) === String(vacancyForm.branchCode));
        if (!branch) { alert('ไม่พบข้อมูลสาขาในระบบ'); return; }
        const isDuplicate = vacancies.some(v => String(v.branchCode) === String(branch.code) && String(v.position) === String(vacancyForm.position) && v.manualStatus !== 'Closed');
        if (isDuplicate) { alert(`มีตำแหน่งเปิดรับอยู่แล้ว!`); return; }

        const newVacancy = { 
          id: Date.now().toString(), area: branch.area, branchCode: String(branch.code).padStart(3, '0'), 
          branchName: branch.name, position: vacancyForm.position, manualStatus: vacancyForm.manualStatus, 
          createdAt: Date.now(), timestamp: getConsistentTimestamp() 
        };
        const newVacs = [newVacancy, ...vacancies];
        setVacancies(newVacs); setVacancyForm({ branchCode: '', position: '', manualStatus: 'Vacant' });
        syncToCloud(applicants, newVacs);
        
        if (GOOGLE_SCRIPT_URL && cloudStatus === 'connected') {
          try {
            fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'notifyNewVacancy', vacancy: newVacancy })
            });
          } catch (error) { console.error('Email Error:', error); }
        }
      };

      const deleteVacancy = (id) => {
        if (window.confirm('ลบตำแหน่งงานนี้?')) {
          setVacancies(vacancies.filter(v => String(v.id) !== String(id))); syncToCloud(applicants, vacancies.filter(v => String(v.id) !== String(id)));
        }
      };

      const startEditVac = (v) => { setEditVacId(v.id); setEditVacForm({ ...v }); };
      const saveEditVac = () => {
        const isDuplicate = vacancies.some(v => String(v.id) !== String(editVacId) && String(v.branchCode) === String(editVacForm.branchCode) && String(v.position) === String(editVacForm.position) && v.manualStatus !== 'Closed');
        if (isDuplicate) { alert(`มีตำแหน่งนี้เปิดรับอยู่แล้ว!`); return; }
        const branch = appBranches.find(b => String(b.code) === String(editVacForm.branchCode));
        const newVacs = vacancies.map(v => String(v.id) === String(editVacId) ? { ...editVacForm, area: branch ? branch.area : v.area, branchName: branch ? branch.name : v.branchName } : v);
        setVacancies(newVacs); setEditVacId(null); syncToCloud(applicants, newVacs);
      };

      const closeVacancy = (id) => {
        const newVacs = vacancies.map(v => String(v.id) === String(id) ? { ...v, manualStatus: 'Closed' } : v);
        setVacancies(newVacs); syncToCloud(applicants, newVacs);
      };

      const availableBranchesForAreas = appBranches.filter(b => selectedAreas.includes(b.area));
      const filteredVacancies = vacancies.filter(v => selectedAreas.length === 0 || selectedAreas.includes(v.area));

      const getVacancyInsights = (v) => {
        const matchedApplicants = applicants.filter(app => String(app.branchCode) === String(v.branchCode) && String(app.position) === String(v.position));
        const applicantCount = matchedApplicants.length;
        let computedStatus = v.manualStatus;
        if (v.manualStatus !== 'Closed') {
          if (matchedApplicants.some(app => app.status === 'มาเริ่มงาน')) computedStatus = 'Hiring';
          else if (matchedApplicants.some(app => app.status === 'รอเริ่มงาน')) computedStatus = 'รอเริ่มงาน';
          else if (matchedApplicants.some(app => app.status === 'ตรวจสุขภาพ')) computedStatus = 'รอตรวจสุขภาพ';
        }
        
        let slaEndTime = Date.now();
        const hiredApps = matchedApplicants.filter(app => ['รอเริ่มงาน', 'มาเริ่มงาน'].includes(app.status));
        if (hiredApps.length > 0) {
          slaEndTime = Math.min(...hiredApps.map(a => parseDateToMs(a.updatedAt) || parseDateToMs(a.timestamp) || parseDateToMs(a.id) || Date.now()));
        }

        let startMs = parseDateToMs(v.createdAt) || parseDateToMs(v.timestamp) || parseDateToMs(v.id) || Date.now();
        const slaDays = Math.max(0, Math.floor((slaEndTime - startMs) / (1000 * 60 * 60 * 24))) || 0;
        return { applicantCount, computedStatus, slaDays, matchedApplicants };
      };

      const activeVacanciesForRecruit = useMemo(() => {
        return vacancies.filter(v => {
          if (v.manualStatus === 'Closed') return false;
          if (recruitAreaFilter && String(v.area) !== String(recruitAreaFilter)) return false;
          if (recruitBranchFilter && String(v.branchCode) !== String(recruitBranchFilter)) return false;
          if (selectedTA) {
            const currentTA = String(selectedTA).trim().toLowerCase();
            const vacPos = String(v.position).trim();
            const vacArea = String(v.area).trim().toLowerCase();
            const posRules = appPositions.filter(p => String(p.position).trim() === vacPos);
            if (posRules.length > 0) {
              let matchingRule = posRules.find(p => {
                if (!p.area || String(p.area).trim() === '') return false;
                return String(p.area).split(',').map(a => a.trim().toLowerCase()).includes(vacArea);
              });
              if (!matchingRule) matchingRule = posRules.find(p => !p.area || String(p.area).trim() === '');
              if (matchingRule) {
                const assignedRecruit = String(matchingRule.recruit).trim().toLowerCase();
                if (assignedRecruit !== '' && assignedRecruit !== currentTA) return false;
              }
            }
          }
          return true;
        });
      }, [vacancies, recruitAreaFilter, recruitBranchFilter, appPositions, selectedTA]);

      const branchesForRecruitFilter = appBranches.filter(b => !recruitAreaFilter || String(b.area) === String(recruitAreaFilter));
      const myApplicants = applicants.filter(app => String(app.ta) === String(selectedTA));
      const dashboardData = useMemo(() => dashboardTA === 'ALL' ? applicants : applicants.filter(app => String(app.ta) === String(dashboardTA)), [applicants, dashboardTA]);
      
      const statusChartData = useMemo(() => {
        const counts = {}; dashboardData.forEach(app => counts[app.status] = (counts[app.status] || 0) + 1);
        return Object.keys(counts).map(key => ({ name: key, value: counts[key] })).sort((a, b) => b.value - a.value);
      }, [dashboardData]);
      
      const branchChartData = useMemo(() => {
        const counts = {}; dashboardData.forEach(app => counts[app.branchName] = (counts[app.branchName] || 0) + 1);
        return Object.keys(counts).map(key => ({ name: key, count: counts[key] })).sort((a, b) => b.count - a.count);
      }, [dashboardData]);

      const slaChartData = useMemo(() => {
        const buckets = [ { name: '0-14 วัน', count: 0, fill: '#10B981' }, { name: '15-30 วัน', count: 0, fill: '#F59E0B' }, { name: '31-45 วัน', count: 0, fill: '#F97316' }, { name: 'เกิน 45 วัน', count: 0, fill: '#EF4444' } ];
        vacancies.forEach(v => {
          if (v.manualStatus !== 'Closed') {
            const { slaDays } = getVacancyInsights(v);
            if (slaDays <= 14) buckets[0].count++; else if (slaDays <= 30) buckets[1].count++; else if (slaDays <= 45) buckets[2].count++; else buckets[3].count++;
          }
        });
        return buckets;
      }, [vacancies, applicants]); 

      return (
        <div className="min-h-screen font-sans text-slate-800 pb-10 relative">
          {isLoading && (
            <div className="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center transition-all">
              <div className="bg-white px-8 py-6 rounded-2xl shadow-xl flex flex-col items-center space-y-4 animate-in fade-in zoom-in duration-300">
                <div className="animate-spin w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full"></div>
                <span className="font-bold text-slate-700 text-lg">กำลังเชื่อมต่อข้อมูล...</span>
              </div>
            </div>
          )}

          <nav className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between h-auto md:h-16 py-3 md:py-0">
              <div className="flex items-center space-x-3 mb-3 md:mb-0">
                <div className="w-9 h-9 rounded-lg bg-blue-600 flex items-center justify-center text-white"><Users size={20} /></div>
                <span className="text-xl font-bold text-slate-900 tracking-tight">HR <span className="text-blue-600">Recruit</span></span>
              </div>
              <div className="flex items-center justify-between overflow-x-auto w-full md:w-auto space-x-4 hide-scrollbar">
                <div className="flex space-x-1 bg-slate-100/80 p-1 rounded-xl whitespace-nowrap">
                  <button onClick={() => setActiveTab('area_hr')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium ${activeTab === 'area_hr' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500'}`}><Briefcase size={16} /><span>Area HR (เปิดงาน)</span></button>
                  <button onClick={() => setActiveTab('entry')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium ${activeTab === 'entry' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500'}`}><UserPlus size={16} /><span>Recruit (คีย์คน)</span></button>
                  <button onClick={() => setActiveTab('dashboard')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium ${activeTab === 'dashboard' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500'}`}><BarChart3 size={16} /><span>Dashboard</span></button>
                </div>
                <div className="flex items-center space-x-2">
                  <div className="hidden md:flex items-center space-x-1.5 px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-50 border border-slate-200">
                    {cloudStatus === 'loading' && <><div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div><span className="text-slate-600">กำลังเชื่อมต่อ</span></>}
                    {cloudStatus === 'connected' && <><div className="w-2 h-2 bg-emerald-500 rounded-full"></div><span className="text-emerald-700">ออนไลน์</span></>}
                    {cloudStatus === 'syncing' && <><div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div><span className="text-blue-700">ซิงค์...</span></>}
                    {cloudStatus === 'error' && <><div className="w-2 h-2 bg-red-500 rounded-full"></div><span className="text-red-700">ออฟไลน์</span></>}
                  </div>
                  <button onClick={() => setShowSettings(true)} className="flex items-center space-x-1.5 bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-2 rounded-lg text-sm font-semibold border"><Settings size={16}/><span className="hidden sm:inline">ตั้งค่า</span></button>
                </div>
              </div>
            </div>
          </nav>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {activeTab === 'area_hr' && (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-sm border p-6">
                  <div className="mb-4 flex items-center justify-between">
                    <h2 className="text-lg font-bold flex items-center space-x-2"><Map className="text-blue-600" size={22} /><span>เลือก Area</span></h2>
                  </div>
                  <div className="flex flex-wrap gap-3">
                    {appAreas.map(area => (
                      <button key={area} onClick={() => toggleArea(area)} className={`px-4 py-2 rounded-xl text-sm font-bold border transition-all ${selectedAreas.includes(area) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300'}`}>{area}</button>
                    ))}
                  </div>
                </div>

                {selectedAreas.length > 0 && (
                  <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div className="bg-slate-50/50 border-b px-6 py-4 flex items-center space-x-3"><div className="bg-blue-100 text-blue-600 p-2 rounded-lg"><Target size={20}/></div><h2 className="font-bold">เปิดตำแหน่งงานว่างใหม่</h2></div>
                    <form onSubmit={handleVacancySubmit} className="p-6 space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <select required name="branchCode" value={vacancyForm.branchCode} onChange={handleVacancyInputChange} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500"><option value="">-- เลือกสาขา --</option>{availableBranchesForAreas.map(b => <option key={b.code} value={b.code}>[{b.area}] {b.name}</option>)}</select>
                        <select required name="position" value={vacancyForm.position} onChange={handleVacancyInputChange} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500"><option value="">-- เลือกตำแหน่งงาน --</option>{uniquePositionNames.map(pos => <option key={pos} value={pos}>{pos}</option>)}</select>
                        <select required name="manualStatus" value={vacancyForm.manualStatus} onChange={handleVacancyInputChange} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500">{VACANCY_STATUSES.filter(s => s !== 'Closed').map(s => <option key={s} value={s}>{s}</option>)}</select>
                      </div>
                      <div className="flex justify-end"><button type="submit" className="bg-slate-800 text-white py-2.5 px-6 rounded-xl flex items-center space-x-2"><Briefcase size={16}/><span>บันทึกตำแหน่ง</span></button></div>
                    </form>
                  </div>
                )}

                {selectedAreas.length > 0 && (
                  <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div className="px-6 py-5 border-b flex justify-between items-center"><h3 className="font-bold text-lg">รายการตำแหน่งงาน (Job Vacancies)</h3><button onClick={() => exportToExcel(filteredVacancies, 'Vacancies')} className="text-xs bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg border font-bold flex items-center"><Download size={14} className="mr-1"/>Export</button></div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left whitespace-nowrap"><thead className="bg-slate-50 border-b"><tr><th className="px-5 py-3">Area / สาขา</th><th className="px-5 py-3">ตำแหน่งงาน</th><th className="px-5 py-3 text-center">SLA</th><th className="px-5 py-3 text-center">ผู้สมัคร</th><th className="px-5 py-3">สถานะงาน</th><th className="px-5 py-3 text-right">จัดการ</th></tr></thead>
                      <tbody>
                        {filteredVacancies.map((v) => {
                          if (editVacId === v.id) {
                            return (
                              <tr key={v.id} className="bg-blue-50"><td className="p-3"><select value={editVacForm.branchCode} onChange={e=>setEditVacForm({...editVacForm, branchCode:e.target.value})} className="w-full border p-1.5 rounded">{availableBranchesForAreas.map(b=><option key={b.code} value={b.code}>{b.name}</option>)}</select></td><td className="p-3"><select value={editVacForm.position} onChange={e=>setEditVacForm({...editVacForm, position:e.target.value})} className="w-full border p-1.5 rounded">{uniquePositionNames.map(pos=><option key={pos} value={pos}>{pos}</option>)}</select></td><td className="p-3 text-center">-</td><td className="p-3 text-center">-</td><td className="p-3"><select value={editVacForm.manualStatus} onChange={e=>setEditVacForm({...editVacForm, manualStatus:e.target.value})} className="w-full border p-1.5 rounded">{VACANCY_STATUSES.map(s=><option key={s} value={s}>{s}</option>)}</select></td><td className="p-3 text-right"><button onClick={saveEditVac} className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs mr-2">บันทึก</button><button onClick={()=>setEditVacId(null)} className="bg-slate-200 text-slate-700 px-2 py-1 rounded text-xs">ยกเลิก</button></td></tr>
                            )
                          }
                          const { applicantCount, computedStatus, slaDays, matchedApplicants } = getVacancyInsights(v);
                          return (
                            <tr key={v.id} className="hover:bg-slate-50 border-b">
                              <td className="px-5 py-4"><div className="text-xs text-blue-600 font-bold">{v.area}</div><div className="font-semibold">{v.branchName}</div></td>
                              <td className="px-5 py-4 font-bold cursor-pointer hover:text-blue-600 group" onClick={()=>startEditVac(v)}>{v.position} <Edit size={12} className="inline opacity-0 group-hover:opacity-100"/></td>
                              <td className="px-5 py-4 text-center font-black text-lg {slaDays > 30 ? 'text-red-500' : ''}">{slaDays}<span className="text-[10px] block">วัน</span></td>
                              <td className="px-5 py-4 text-center"><button onClick={()=>setViewApplicants({position:v.position, branchName:v.branchName, list:matchedApplicants})} disabled={applicantCount===0} className={`w-8 h-8 rounded-lg font-bold border ${applicantCount>0?'bg-blue-50 text-blue-700':'bg-slate-50 text-slate-400'}`}>{applicantCount}</button></td>
                              <td className="px-5 py-4"><span className="px-2.5 py-1 rounded-full text-xs font-bold" style={{backgroundColor:VACANCY_COLORS[computedStatus]+'15', color:VACANCY_COLORS[computedStatus]}}>{computedStatus}</span></td>
                              <td className="px-5 py-4 text-right space-x-2">
                                <button onClick={()=>startEditVac(v)} className="p-1.5 text-slate-400 hover:text-blue-600"><Edit size={16}/></button>
                                <button onClick={()=>deleteVacancy(v.id)} className="p-1.5 text-slate-400 hover:text-red-600"><Trash2 size={16}/></button>
                              </td>
                            </tr>
                          )
                        })}
                      </tbody></table>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'entry' && (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-sm border p-6">
                  <h2 className="text-lg font-bold flex items-center mb-4"><UserPlus className="text-blue-600 mr-2"/> เลือก TA (Recruiter)</h2>
                  <select value={selectedTA} onChange={e=>setSelectedTA(e.target.value)} className="w-full md:w-1/2 border rounded-xl px-4 py-3 outline-none focus:border-blue-500"><option value="">-- ระบุ TA --</option>{appTAs.map(ta=><option key={ta} value={ta}>{ta}</option>)}</select>
                </div>
                
                {selectedTA && (
                  <>
                    <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                      <div className="p-6 border-b flex flex-wrap gap-4 justify-between items-center bg-slate-50/50">
                        <h3 className="font-bold text-lg">ตำแหน่งงานที่เปิดรับ (กรองตาม TA อัตโนมัติ)</h3>
                        <div className="flex space-x-2"><select value={recruitAreaFilter} onChange={e=>{setRecruitAreaFilter(e.target.value);setRecruitBranchFilter('')}} className="border rounded-lg px-2 py-1.5 text-sm"><option value="">ทุก Area</option>{appAreas.map(a=><option key={a}>{a}</option>)}</select><select value={recruitBranchFilter} onChange={e=>setRecruitBranchFilter(e.target.value)} disabled={!recruitAreaFilter} className="border rounded-lg px-2 py-1.5 text-sm"><option value="">ทุกสาขา</option>{branchesForRecruitFilter.map(b=><option key={b.code} value={b.code}>{b.name}</option>)}</select></div>
                      </div>
                      <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-white border-b"><tr><th className="p-4">สาขา</th><th className="p-4">ตำแหน่ง</th><th className="p-4 text-center">รับแล้ว</th><th className="p-4">สถานะ</th><th className="p-4 text-right">ดำเนินการ</th></tr></thead>
                        <tbody>{activeVacanciesForRecruit.map(v => {
                          const { applicantCount, computedStatus } = getVacancyInsights(v);
                          return <tr key={v.id} className="border-b hover:bg-slate-50"><td className="p-4"><div className="text-xs font-bold text-blue-600">{v.area}</div><div className="font-semibold">{v.branchName}</div></td><td className="p-4 font-bold">{v.position}</td><td className="p-4 text-center"><span className="px-2 py-1 border rounded bg-slate-50">{applicantCount}</span></td><td className="p-4"><span className="px-2 py-1 rounded-full text-xs font-bold" style={{color:VACANCY_COLORS[computedStatus]}}>{computedStatus}</span></td><td className="p-4 text-right"><button onClick={()=>setAddingApplicantFor(v)} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold">เพิ่มผู้สมัคร</button></td></tr>
                        })}</tbody>
                      </table></div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border mt-6">
                      <div className="p-5 border-b flex justify-between items-center"><h3 className="font-bold">ประวัติของคุณ</h3><button onClick={()=>exportToExcel(myApplicants, 'MyApps')} className="text-xs border px-2 py-1 rounded bg-slate-50">Export</button></div>
                      <div className="overflow-x-auto"><table className="w-full text-sm text-left"><tbody>
                        {myApplicants.map(app => {
                          if (editAppId === app.id) return (
                            <tr key={app.id} className="bg-blue-50/50"><td className="p-3 font-semibold text-xs">{app.branchName}</td><td className="p-3 space-y-1"><input value={editAppForm.name} onChange={e=>setEditAppForm({...editAppForm, name:e.target.value})} className="w-full border p-1 text-xs"/><input value={editAppForm.phone} onChange={e=>setEditAppForm({...editAppForm, phone:e.target.value})} className="w-full border p-1 text-xs"/></td><td className="p-3 space-y-1"><select value={editAppForm.status} onChange={e=>setEditAppForm({...editAppForm, status:e.target.value})} className="w-full border p-1 text-xs">{STATUSES.map(s=><option key={s}>{s}</option>)}</select>{editAppForm.status==='รอเริ่มงาน'&&<input type="date" value={editAppForm.startDate||''} onChange={e=>setEditAppForm({...editAppForm, startDate:e.target.value})} className="w-full border p-1 text-xs"/>}{['อื่นๆ','ไม่ผ่าน','ไม่มาเริ่มงาน'].includes(editAppForm.status)&&<input placeholder="เหตุผล" value={editAppForm.comment||''} onChange={e=>setEditAppForm({...editAppForm, comment:e.target.value})} className="w-full border p-1 text-xs"/>}</td><td className="p-3 text-right"><button onClick={saveEditApp} className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs mr-2">บันทึก</button><button onClick={()=>setEditAppId(null)} className="bg-slate-200 px-2 py-1 rounded text-xs">ยกเลิก</button></td></tr>
                          )
                          return (
                            <tr key={app.id} className="border-t hover:bg-slate-50"><td className="p-4"><div className="font-semibold">{app.branchName}</div></td><td className="p-4 cursor-pointer group" onClick={()=>startEditApp(app)}><div className="font-bold group-hover:text-blue-600">{app.name} <Edit size={12} className="inline opacity-0 group-hover:opacity-100"/></div><div className="text-xs text-slate-500">{app.position} • {app.phone}</div></td><td className="p-4"><select value={app.status} onChange={e=>handleInlineStatusChange(app, e.target.value)} className="status-select font-bold text-xs px-2 py-1 rounded-full outline-none border" style={{color:STATUS_COLORS[app.status], borderColor:STATUS_COLORS[app.status]}}>{STATUSES.map(s=><option key={s}>{s}</option>)}</select>{app.comment && <div className="text-xs text-slate-500 mt-1.5 max-w-[200px] truncate" title={app.comment}>เหตุผล: {app.comment}</div>}{app.status==='รอเริ่มงาน'&&app.startDate&&<div className="text-[10px] text-sky-600 mt-1">เริ่ม: {new Date(app.startDate).toLocaleDateString('th')}</div>}</td><td className="p-4 text-right space-x-2"><button onClick={()=>startEditApp(app)} className="text-slate-400 hover:text-blue-600"><Edit size={16}/></button><button onClick={()=>deleteApplicant(app.id)} className="text-slate-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>
                          )
                        })}
                      </tbody></table></div>
                    </div>
                  </>
                )}

                {addingApplicantFor && (
                  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden">
                      <div className="px-6 py-4 border-b bg-blue-600 text-white flex justify-between items-center"><h3 className="font-bold">เพิ่มผู้สมัคร: {addingApplicantFor.position}</h3><button onClick={()=>setAddingApplicantFor(null)}><X size={20}/></button></div>
                      <form onSubmit={handleRecruitSubmit} className="p-6 space-y-4">
                        <input required placeholder="ชื่อ-นามสกุล" value={formData.name} onChange={handleInputChange} name="name" className="w-full border rounded-xl p-3 outline-none focus:border-blue-500"/>
                        <input required type="tel" placeholder="เบอร์โทร" value={formData.phone} onChange={handleInputChange} name="phone" className="w-full border rounded-xl p-3 outline-none focus:border-blue-500"/>
                        <select required name="status" value={formData.status} onChange={handleInputChange} className="w-full border rounded-xl p-3 outline-none focus:border-blue-500"><option value="">-- สถานะปัจจุบัน --</option>{STATUSES.map(s=><option key={s}>{s}</option>)}</select>
                        {formData.status === 'รอเริ่มงาน' && <input required type="date" name="startDate" value={formData.startDate||''} onChange={handleInputChange} className="w-full border border-sky-300 rounded-xl p-3"/>}
                        {['อื่นๆ','ไม่ผ่าน','ไม่มาเริ่มงาน'].includes(formData.status) && <textarea required name="comment" value={formData.comment} onChange={handleInputChange} placeholder="ระบุเหตุผล" className="w-full border border-orange-300 rounded-xl p-3"></textarea>}
                        <div className="flex items-center space-x-2 border p-3 rounded-xl"><Upload size={16}/><input type="file" onChange={handleFileUpload} className="text-sm w-full"/></div>
                        <div className="pt-4 flex justify-end"><button type="submit" className="bg-blue-600 text-white font-bold px-6 py-2.5 rounded-xl shadow-md">บันทึกข้อมูล</button></div>
                      </form>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                <div className="bg-slate-900 p-8 rounded-3xl text-white flex justify-between items-center">
                  <div><h2 className="text-2xl font-black">Executive Dashboard</h2></div>
                  <select value={dashboardTA} onChange={e=>setDashboardTA(e.target.value)} className="bg-white/10 p-2 rounded-xl text-white outline-none"><option value="ALL">All TAs</option>{appTAs.map(t=><option key={t}>{t}</option>)}</select>
                </div>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                   <div className="bg-white p-5 rounded-2xl border shadow-sm"><div className="text-sm text-slate-500 font-bold mb-2">รวมผู้สมัคร</div><div className="text-3xl font-black">{dashboardData.length}</div></div>
                   <div className="bg-white p-5 rounded-2xl border shadow-sm"><div className="text-sm text-emerald-600 font-bold mb-2">สำเร็จ (Hired)</div><div className="text-3xl font-black">{dashboardData.filter(a=>['มาเริ่มงาน','ผ่าน'].includes(a.status)).length}</div></div>
                   <div className="bg-white p-5 rounded-2xl border shadow-sm"><div className="text-sm text-amber-600 font-bold mb-2">รอดำเนินการ</div><div className="text-3xl font-black">{dashboardData.filter(a=>['รอพิจารณาประวัติ', 'รอสัมภาษณ์','รอเริ่มงาน','ตรวจสุขภาพ'].includes(a.status)).length}</div></div>
                   <div className="bg-white p-5 rounded-2xl border shadow-sm"><div className="text-sm text-red-600 font-bold mb-2">ไม่ผ่าน/ปฏิเสธ</div><div className="text-3xl font-black">{dashboardData.filter(a=>['ไม่ผ่าน','ไม่มาเริ่มงาน'].includes(a.status)).length}</div></div>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                   <div className="bg-white p-6 rounded-3xl border shadow-sm h-[350px]">
                      <h3 className="font-bold mb-4">แหล่งที่มาแยกตามสาขา</h3>
                      <ResponsiveContainer width="100%" height="100%"><BarChart data={branchChartData}><XAxis dataKey="name" tick={{fontSize:10}}/><Bar dataKey="count" fill="#3B82F6" radius={[4,4,0,0]}/><RechartsTooltip/></BarChart></ResponsiveContainer>
                   </div>
                   <div className="bg-white p-6 rounded-3xl border shadow-sm h-[350px]">
                      <h3 className="font-bold mb-4">สถานะผู้สมัคร</h3>
                      <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={statusChartData} innerRadius={60} outerRadius={90} dataKey="value">{statusChartData.map((e,i)=><Cell key={i} fill={STATUS_COLORS[e.name]||'#ccc'}/>)}</Pie><Legend/><RechartsTooltip/></PieChart></ResponsiveContainer>
                   </div>
                   <div className="bg-white p-6 rounded-3xl border shadow-sm lg:col-span-2 h-[350px]">
                      <h3 className="font-bold mb-4">Vacancy SLA Aging (อายุงานว่าง)</h3>
                      <ResponsiveContainer width="100%" height="100%"><BarChart data={slaChartData}><XAxis dataKey="name"/><Bar dataKey="count" fill="#10B981" radius={[4,4,0,0]}>{slaChartData.map((e,i)=><Cell key={i} fill={e.fill}/>)}</Bar><RechartsTooltip/></BarChart></ResponsiveContainer>
                   </div>
                </div>
              </div>
            )}

            {/* Modals for Settings & Viewing */}
            {showSettings && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60">
                <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm relative">
                  <button onClick={()=>setShowSettings(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><X/></button>
                  <h3 className="font-bold text-lg mb-6">ตั้งค่า Master Data (CSV)</h3>
                  <div className="space-y-3">
                    <label className="flex items-center justify-between border p-3 rounded-xl cursor-pointer hover:bg-slate-50"><span className="text-sm font-bold">1. อัปเดตไฟล์สาขา</span><Upload size={16}/><input type="file" className="hidden" onChange={e=>{handleImportCSV(e);setShowSettings(false)}}/></label>
                    <label className="flex items-center justify-between border p-3 rounded-xl cursor-pointer hover:bg-slate-50"><span className="text-sm font-bold">2. ไฟล์ตำแหน่งงาน-TA</span><Upload size={16}/><input type="file" className="hidden" onChange={e=>{handleImportPositionCSV(e);setShowSettings(false)}}/></label>
                    <label className="flex items-center justify-between border p-3 rounded-xl cursor-pointer hover:bg-slate-50"><span className="text-sm font-bold">3. ไฟล์รายชื่อ TA</span><Upload size={16}/><input type="file" className="hidden" onChange={e=>{handleImportTACSV(e);setShowSettings(false)}}/></label>
                  </div>
                </div>
              </div>
            )}
            
            {viewApplicants && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60">
                <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg relative max-h-[80vh] overflow-y-auto">
                  <button onClick={()=>setViewApplicants(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><X/></button>
                  <h3 className="font-bold text-lg mb-4">ผู้สมัคร: {viewApplicants.position}</h3>
                  <div className="space-y-2">{viewApplicants.list.map(a=><div key={a.id} className="p-3 border rounded-xl flex justify-between"><div className="text-sm"><p className="font-bold">{a.name}</p><p className="text-slate-500">{a.phone}</p></div><div className="text-right"><span className="text-xs font-bold bg-slate-100 px-2 py-1 rounded" style={{color:STATUS_COLORS[a.status]}}>{a.status}</span><p className="text-[10px] mt-1">{a.ta}</p></div></div>)}</div>
                </div>
              </div>
            )}
            
            {previewFile && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80">
                <div className="bg-white p-4 rounded-xl w-full max-w-3xl h-[80vh] flex flex-col relative">
                  <button onClick={()=>setPreviewFile(null)} className="absolute -top-3 -right-3 bg-white rounded-full p-1 shadow-md"><X/></button>
                  {previewFile.base64.startsWith('data:image/') || previewFile.base64.startsWith('data:application/pdf') ? <iframe src={previewFile.base64} className="w-full h-full rounded border"/> : <div className="flex-1 flex items-center justify-center"><a href={previewFile.base64} download={previewFile.name} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">ดาวน์โหลดไฟล์ {previewFile.name}</a></div>}
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
