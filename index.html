<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HR Recruitment Workspace</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS for Excel/CSV Parsing and Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React Code -->
  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';
    import { Users, UserPlus, BarChart3, Building2, CheckCircle2, Clock, MapPin, Search, AlertCircle, FileText, Briefcase, Phone, MessageSquare, Map, Target, Edit, Trash2, X, BellRing, Download, Paperclip, Upload, Eye, PlusCircle } from 'https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0';

    // ==========================================
    // ⚙️ การตั้งค่า GOOGLE SHEETS API
    // ==========================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzM4EXsW141-nqY7rRwU_MFc9vnrJSbK-8Wdwn-ZJwvfEBlNMZJH2dhE0r2C4uJf7mnxg/exec"; 

    // --- MOCK DATA ---
    const DEFAULT_TAS = ['TA 1 (คุณเอ)', 'TA 2 (คุณบี)', 'TA 3 (คุณซี)', 'TA 4 (คุณดี)'];
    const DEFAULT_POSITIONS = ['ผู้จัดการสาขา', 'ผู้ช่วยผู้จัดการสาขา', 'พนักงานขาย', 'พนักงานแคชเชียร์', 'พนักงานจัดเรียงสินค้า', 'พนักงานธุรการ', 'บัญชี'];

    // ดึงข้อมูลสาขาจาก CSV ที่ระบบอ่านได้เบื้องต้น
    const DEFAULT_BRANCHES = [
      { code: '001', name: 'สาขาลาดพร้าว', area: 'Area 5' },
      { code: '002', name: 'สาขาแจ้งวัฒนะ', area: 'Area 10' },
      { code: '003', name: 'สาขาศรีนครินทร์', area: 'Area 11' },
      { code: '004', name: 'สาขาบางบอน', area: 'Area 1' },
      { code: '005', name: 'สาขาชลบุรี', area: 'Area 9' },
      { code: '006', name: 'สาขาเชียงใหม่ 1 (ตลาดเมืองใหม่)', area: 'Area 6' },
      { code: '007', name: 'สาขานครราชสีมา', area: 'Area 2' },
      { code: '008', name: 'สาขารังสิต', area: 'Area 11' },
      { code: '009', name: 'สาขาหาดใหญ่', area: 'Area 4' },
      { code: '010', name: 'สาขาอุดรธานี', area: 'Area 7' },
      { code: '011', name: 'สาขาพิษณุโลก', area: 'Area 2' },
      { code: '012', name: 'สาขาขอนแก่น', area: 'Area 7' },
      { code: '013', name: 'สาขาสุราษฏร์ธานี', area: 'Area 4' },
      { code: '014', name: 'สาขาอุบลราชธานี', area: 'Area 8' },
      { code: '015', name: 'สาขาระยอง', area: 'Area 14' },
      { code: '016', name: 'สาขานครสวรรค์', area: 'Area 2' },
      { code: '017', name: 'สาขาจรัญสนิทวงศ์', area: 'Area 10' },
      { code: '018', name: 'สาขาสาทร', area: 'Area 13' },
      { code: '019', name: 'สาขานครปฐม', area: 'Area 5' },
      { code: '020', name: 'สาขาสุรินทร์', area: 'Area 8' },
      { code: '021', name: 'สาขาสามเสน', area: 'Area 13' },
      { code: '022', name: 'สาขานครศรีธรรมราช', area: 'Area 4' },
      { code: '023', name: 'สาขาเชียงราย', area: 'Area 6' },
      { code: '122', name: 'สาขาประชาอุทิศ', area: 'Area 3' },
      { code: '123', name: 'สาขาสุขุมวิท 71', area: 'Area 11' },
      { code: '124', name: 'สาขานวมินทร์ 70', area: 'Area 11' },
      { code: '125', name: 'สาขาชะอำ', area: 'Area 13' },
      { code: '126', name: 'สาขาอ่อนนุช', area: 'Area 11' },
      { code: '127', name: 'สาขาสุขสวัสดิ์', area: 'Area 3' },
      { code: '128', name: 'สาขากบินทร์บุรี', area: 'Area 14' },
      { code: '129', name: 'สาขาลาดกระบัง', area: 'Area 9' },
      { code: '130', name: 'สาขานาทองเจริญ', area: 'Area 3' },
      { code: '131', name: 'สาขาบ่อวิน', area: 'Area 9' },
      { code: '132', name: 'สาขาสัตหีบ', area: 'Area 9' },
      { code: '133', name: 'สาขารามคำแหง 24', area: 'Area 5' },
      { code: '134', name: 'สาขาอมตะนคร', area: 'Area 9' },
      { code: '135', name: 'สาขาบางคอแหลม', area: 'Area 13' },
      { code: '136', name: 'สาขาขอนแก่น 2', area: 'Area 7' },
      { code: '137', name: 'สาขาตลาดวงศกร 2', area: 'Area 13' },
      { code: '138', name: 'สาขาเหม่งจ๋าย', area: 'Area 13' },
      { code: '139', name: 'สาขาสุขุมวิท 22', area: 'Area 13' },
      { code: '140', name: 'สาขาถนนจันทน์', area: 'Area 13' },
      { code: '141', name: 'สาขาลำลูกกา', area: 'Area 3' },
      { code: '142', name: 'สาขาแพรกษา', area: 'Area 14' },
      { code: '143', name: 'สาขาประดิษฐ์มนูธรรม', area: 'Area 13' },
      { code: '144', name: 'สาขาตลาดรุ่งโรจน์', area: 'Area 3' }
    ];

    const STATUSES = ['รอสัมภาษณ์', 'ไม่เข้าสัมภาษณ์', 'ผ่าน', 'ไม่ผ่าน', 'สำรอง', 'ตรวจสุขภาพ', 'รอเริ่มงาน', 'มาเริ่มงาน', 'ไม่มาเริ่มงาน', 'อื่นๆ'];
    const VACANCY_STATUSES = ['Vacant', 'Promote&Transfer', 'Hold', 'Closed'];

    const STATUS_COLORS = { 'รอสัมภาษณ์': '#F59E0B', 'ไม่เข้าสัมภาษณ์': '#64748B', 'ผ่าน': '#10B981', 'ไม่ผ่าน': '#EF4444', 'สำรอง': '#3B82F6', 'ตรวจสุขภาพ': '#8B5CF6', 'รอเริ่มงาน': '#0EA5E9', 'มาเริ่มงาน': '#059669', 'ไม่มาเริ่มงาน': '#94A3B8', 'อื่นๆ': '#F97316' };
    const VACANCY_COLORS = { 'Vacant': '#F59E0B', 'Promote&Transfer': '#8B5CF6', 'Hold': '#64748B', 'Closed': '#94A3B8', 'รอตรวจสุขภาพ': '#0EA5E9', 'Hiring': '#10B981' };

    function App() {
      const [activeTab, setActiveTab] = useState('area_hr');
      const [isLoading, setIsLoading] = useState(true); // เพิ่ม State สำหรับโหลดข้อมูลจาก Cloud
      
      // --- STATE: ข้อมูลตั้งต้น ---
      const [appBranches, setAppBranches] = useState([]);
      const [appAreas, setAppAreas] = useState([]);
      const [appTAs, setAppTAs] = useState([]);
      const [appPositions, setAppPositions] = useState([]);
      
      // --- STATE: HR Recruit ---
      const [selectedTA, setSelectedTA] = useState('');
      const [recruitAreaFilter, setRecruitAreaFilter] = useState('');
      const [recruitBranchFilter, setRecruitBranchFilter] = useState('');
      const [addingApplicantFor, setAddingApplicantFor] = useState(null);
      const [formData, setFormData] = useState({ name: '', phone: '', status: '', comment: '', resumeName: '', resumeBase64: '' });
      const [editingApplicant, setEditingApplicant] = useState(null);
      const [applicants, setApplicants] = useState([]);

      // --- STATE: Preview File ---
      const [previewFile, setPreviewFile] = useState(null);

      // --- STATE: Area HR ---
      const [selectedAreas, setSelectedAreas] = useState([]);
      const [vacancyForm, setVacancyForm] = useState({ branchCode: '', position: '', manualStatus: 'Vacant' });
      const [editingVacancy, setEditingVacancy] = useState(null);
      const [viewApplicants, setViewApplicants] = useState(null);
      const [vacancies, setVacancies] = useState([]);

      const [dashboardTA, setDashboardTA] = useState('ALL');

      // --- EFFECTS: Load Data from Google Sheets ---
      useEffect(() => {
        const initLoad = async () => {
          setIsLoading(true);
          try {
            if (GOOGLE_SCRIPT_URL) {
              const res = await fetch(GOOGLE_SCRIPT_URL);
              const data = await res.json();
              if (data.applicants) setApplicants(data.applicants);
              if (data.vacancies) setVacancies(data.vacancies);
              
              // โหลดข้อมูล Master จาก Cloud ถ้ามี (เพื่อให้ทุกคนเห็นสาขาตรงกัน)
              if (data.branches && data.branches.length > 0) setAppBranches(data.branches);
              else setAppBranches(DEFAULT_BRANCHES);
              
              if (data.tas && data.tas.length > 0) setAppTAs(data.tas.map(t => t.name));
              else setAppTAs(DEFAULT_TAS);
              
              if (data.positions && data.positions.length > 0) setAppPositions(data.positions.map(p => p.name));
              else setAppPositions(DEFAULT_POSITIONS);

            }
          } catch (e) {
            console.error("ดึงข้อมูลจาก Cloud ไม่สำเร็จ, ใช้ข้อมูลสำรองในเครื่อง", e);
            const localApps = localStorage.getItem('hr_applicants');
            const localVacs = localStorage.getItem('hr_vacancies');
            if(localApps) setApplicants(JSON.parse(localApps));
            if(localVacs) setVacancies(JSON.parse(localVacs));
            setAppBranches(DEFAULT_BRANCHES);
            setAppTAs(DEFAULT_TAS);
            setAppPositions(DEFAULT_POSITIONS);
          }
          
          setIsLoading(false);
        };
        
        initLoad();
      }, []);

      // สร้างรายชื่อ Area ให้เรียงตามตัวเลข
      useEffect(() => {
        if (appBranches.length > 0) {
          const uniqueAreas = [...new Set(appBranches.map(b => b.area))].sort((a,b) => {
            const numA = parseInt(a.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.replace(/\D/g, '')) || 0;
            return numA - numB;
          });
          setAppAreas(uniqueAreas);
        }
      }, [appBranches]);

      // --- ฟังก์ชัน Sync การทำรายการบันทึก (Applicants, Vacancies) ขึ้น Cloud ---
      const syncToCloud = async (newApps, newVacs) => {
        localStorage.setItem('hr_applicants', JSON.stringify(newApps));
        localStorage.setItem('hr_vacancies', JSON.stringify(newVacs));
        
        if (GOOGLE_SCRIPT_URL) {
          try {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'saveAll', applicants: newApps, vacancies: newVacs })
            });
          } catch (error) {
            console.error('Sync Error:', error);
          }
        }
      };

      // --- ฟังก์ชัน Sync Master Data (Branches, TAs, Positions) ขึ้น Cloud ---
      const syncMasterToCloud = async (newBranches, newTAs, newPositions) => {
        if (GOOGLE_SCRIPT_URL) {
          try {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ 
                action: 'updateMaster', 
                branches: newBranches, 
                tas: newTAs.map(name => ({name})), 
                positions: newPositions.map(name => ({name})) 
              })
            });
          } catch (error) {
            console.error('Sync Master Error:', error);
          }
        }
      };

      // --- IMPORT CSV FUNCTIONS ---
      const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newBranches = [];
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0] && row[1] && row[2]) {
                const code = String(row[0]).padStart(3, '0');
                const name = String(row[1]).replace(/\n/g, ' ').replace(/\r/g, '').trim();
                const area = String(row[2]).replace(/\r/g, '').trim();
                newBranches.push({ code, name, area });
              }
            }

            if (newBranches.length > 0) {
              setAppBranches(newBranches);
              syncMasterToCloud(newBranches, appTAs, appPositions);
              alert(`อัปเดตข้อมูลสาขาและส่งขึ้นระบบเรียบร้อย! นำเข้าทั้งหมด ${newBranches.length} สาขา`);
            } else {
              alert('ไม่พบข้อมูลในไฟล์ หรือรูปแบบคอลัมน์ไม่ถูกต้อง (ต้องมี Store No., Location Name, Area No.)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV สาขา');
          }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportTACSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newTAs = [];
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0]) {
                const taName = String(row[0]).trim();
                if (taName) newTAs.push(taName);
              }
            }

            if (newTAs.length > 0) {
              setAppTAs(newTAs);
              syncMasterToCloud(appBranches, newTAs, appPositions);
              alert(`อัปเดตรายชื่อ TA และส่งขึ้นระบบเรียบร้อย! นำเข้าทั้งหมด ${newTAs.length} รายชื่อ`);
            } else {
              alert('ไม่พบข้อมูลในไฟล์ (ข้อมูลชื่อ TA ต้องอยู่ในคอลัมน์แรกสุด)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV รายชื่อ TA');
          }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportPositionCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newPositions = [];
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0]) {
                const posName = String(row[0]).trim();
                if (posName) newPositions.push(posName);
              }
            }

            if (newPositions.length > 0) {
              setAppPositions(newPositions);
              syncMasterToCloud(appBranches, appTAs, newPositions);
              alert(`อัปเดตตำแหน่งงานและส่งขึ้นระบบเรียบร้อย! นำเข้าทั้งหมด ${newPositions.length} รายการ`);
            } else {
              alert('ไม่พบข้อมูลในไฟล์ (ข้อมูลตำแหน่งงานต้องอยู่ในคอลัมน์แรกสุด)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV ตำแหน่งงาน');
          }
        };
        reader.readAsBinaryString(file);
      };

      // --- EXPORT EXCEL ---
      const exportToExcel = (dataList, filename) => {
        const worksheet = XLSX.utils.json_to_sheet(dataList);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
        XLSX.writeFile(workbook, `${filename}.xlsx`);
      };

      // --- HANDLERS: HR Recruit ---
      const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
      
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setFormData(prev => ({ ...prev, resumeBase64: reader.result, resumeName: file.name }));
          };
          reader.readAsDataURL(file);
        }
      };
      
      const handleRecruitSubmit = async (e) => {
        e.preventDefault();
        if (!selectedTA || !addingApplicantFor) return;
        
        const newRecord = { 
          id: Date.now().toString(), 
          ta: selectedTA, 
          branchCode: addingApplicantFor.branchCode, 
          branchName: addingApplicantFor.branchName, 
          position: addingApplicantFor.position,
          ...formData, 
          timestamp: new Date().toLocaleString('th-TH') 
        };
        
        const newApps = [newRecord, ...applicants];
        setApplicants(newApps);
        setFormData({ name: '', phone: '', status: '', comment: '', resumeName: '', resumeBase64: '' });
        setAddingApplicantFor(null);
        
        syncToCloud(newApps, vacancies);
      };

      const deleteApplicant = (id) => {
        if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลผู้สมัครรายนี้?')) {
          const newApps = applicants.filter(a => a.id !== id);
          setApplicants(newApps);
          syncToCloud(newApps, vacancies);
        }
      };

      const submitEditApplicant = (e) => {
        e.preventDefault();
        const newApps = applicants.map(a => a.id === editingApplicant.id ? editingApplicant : a);
        setApplicants(newApps);
        setEditingApplicant(null);
        syncToCloud(newApps, vacancies);
      };

      // --- HANDLERS: Area HR ---
      const toggleArea = (area) => {
        setSelectedAreas(prev => prev.includes(area) ? prev.filter(a => a !== area) : [...prev, area]);
        setVacancyForm(prev => ({...prev, branchCode: ''}));
      };
      const handleVacancyInputChange = (e) => setVacancyForm(prev => ({ ...prev, [e.target.name]: e.target.value }));

      const handleVacancySubmit = (e) => {
        e.preventDefault();
        const branch = appBranches.find(b => b.code === vacancyForm.branchCode);
        if (!branch) return;

        const isDuplicate = vacancies.some(v => v.branchCode === branch.code && v.position === vacancyForm.position && v.manualStatus !== 'Closed');
        if (isDuplicate) { alert(`มีตำแหน่ง "${vacancyForm.position}" เปิดรับในสาขานี้อยู่แล้ว!`); return; }

        const newVacancy = { 
          id: Date.now().toString(), 
          area: branch.area, 
          branchCode: branch.code, 
          branchName: branch.name, 
          position: vacancyForm.position, 
          manualStatus: vacancyForm.manualStatus, 
          createdAt: Date.now(), 
          timestamp: new Date().toLocaleString('th-TH') 
        };
        
        const newVacs = [newVacancy, ...vacancies];
        setVacancies(newVacs);
        setVacancyForm({ branchCode: '', position: '', manualStatus: 'Vacant' });
        syncToCloud(applicants, newVacs);
      };

      const deleteVacancy = (id) => {
        if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบตำแหน่งงานนี้?')) {
          const newVacs = vacancies.filter(v => v.id !== id);
          setVacancies(newVacs);
          syncToCloud(applicants, newVacs);
        }
      };

      const submitEditVacancy = (e) => {
        e.preventDefault();
        const isDuplicate = vacancies.some(v => v.id !== editingVacancy.id && v.branchCode === editingVacancy.branchCode && v.position === editingVacancy.position && v.manualStatus !== 'Closed');
        if (isDuplicate) { alert(`มีตำแหน่ง "${editingVacancy.position}" เปิดรับในสาขานี้อยู่แล้ว!`); return; }
        
        const branch = appBranches.find(b => b.code === editingVacancy.branchCode);
        const newVacs = vacancies.map(v => v.id === editingVacancy.id ? { ...editingVacancy, area: branch.area, branchName: branch.name } : v);
        setVacancies(newVacs);
        setEditingVacancy(null);
        syncToCloud(applicants, newVacs);
      };

      const closeVacancy = (id) => {
        const newVacs = vacancies.map(v => v.id === id ? { ...v, manualStatus: 'Closed' } : v);
        setVacancies(newVacs);
        syncToCloud(applicants, newVacs);
      };

      // --- DERIVED DATA ---
      const availableBranchesForAreas = appBranches.filter(b => selectedAreas.includes(b.area));
      const filteredVacancies = vacancies.filter(v => selectedAreas.length === 0 || selectedAreas.includes(v.area));

      const getVacancyInsights = (branchCode, position, manualStatus, createdAt) => {
        const matchedApplicants = applicants.filter(app => app.branchCode === branchCode && app.position === position);
        const applicantCount = matchedApplicants.length;
        let computedStatus = manualStatus;
        if (manualStatus !== 'Closed') {
          if (matchedApplicants.some(app => app.status === 'มาเริ่มงาน')) computedStatus = 'Hiring';
          else if (matchedApplicants.some(app => app.status === 'ตรวจสุขภาพ')) computedStatus = 'รอตรวจสุขภาพ';
        }
        const slaDays = Math.max(0, Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24)));
        return { applicantCount, computedStatus, slaDays, matchedApplicants };
      };

      // สำหรับแท็บ Recruit: กรองตำแหน่งงานที่ยังไม่ปิดรับ (เพื่อให้ Recruit เลือกเพิ่มคน)
      const activeVacanciesForRecruit = useMemo(() => {
        return vacancies.filter(v => {
          if (v.manualStatus === 'Closed') return false;
          if (recruitAreaFilter && v.area !== recruitAreaFilter) return false;
          if (recruitBranchFilter && v.branchCode !== recruitBranchFilter) return false;
          return true;
        });
      }, [vacancies, recruitAreaFilter, recruitBranchFilter]);

      const branchesForRecruitFilter = appBranches.filter(b => !recruitAreaFilter || b.area === recruitAreaFilter);
      
      // ประวัติของ TA ปัจจุบัน
      const myApplicants = applicants.filter(app => app.ta === selectedTA);

      const dashboardData = useMemo(() => dashboardTA === 'ALL' ? applicants : applicants.filter(app => app.ta === dashboardTA), [applicants, dashboardTA]);
      
      const statusChartData = useMemo(() => {
        const counts = {}; dashboardData.forEach(app => counts[app.status] = (counts[app.status] || 0) + 1);
        return Object.keys(counts).map(key => ({ name: key, value: counts[key] })).sort((a, b) => b.value - a.value);
      }, [dashboardData]);
      
      const branchChartData = useMemo(() => {
        const counts = {}; dashboardData.forEach(app => counts[app.branchName] = (counts[app.branchName] || 0) + 1);
        return Object.keys(counts).map(key => ({ name: key, count: counts[key] })).sort((a, b) => b.count - a.count);
      }, [dashboardData]);

      // สร้างข้อมูลสำหรับกราฟ SLA
      const slaChartData = useMemo(() => {
        const buckets = [
          { name: '0-14 วัน', count: 0, fill: '#10B981' }, 
          { name: '15-30 วัน', count: 0, fill: '#F59E0B' }, 
          { name: '31-45 วัน', count: 0, fill: '#F97316' }, 
          { name: 'เกิน 45 วัน', count: 0, fill: '#EF4444' } 
        ];
        vacancies.forEach(v => {
          if (v.manualStatus !== 'Closed') {
            const slaDays = Math.max(0, Math.floor((Date.now() - v.createdAt) / (1000 * 60 * 60 * 24)));
            if (slaDays <= 14) buckets[0].count++;
            else if (slaDays <= 30) buckets[1].count++;
            else if (slaDays <= 45) buckets[2].count++;
            else buckets[3].count++;
          }
        });
        return buckets;
      }, [vacancies]);


      // --- COMPONENTS ---
      return (
        <div className="min-h-screen font-sans text-slate-800 pb-10 relative">
          
          {/* Loading Overlay ตอนดึงข้อมูลครั้งแรก */}
          {isLoading && (
            <div className="fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center">
              <div className="bg-white px-8 py-6 rounded-2xl shadow-xl flex flex-col items-center space-y-4">
                <div className="animate-spin w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full"></div>
                <span className="font-bold text-slate-700">กำลังเชื่อมต่อข้อมูลกับ Google Sheets...</span>
              </div>
            </div>
          )}

          {/* Navbar */}
          <nav className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex flex-col md:flex-row justify-between h-auto md:h-16 py-3 md:py-0">
                <div className="flex items-center space-x-3 mb-3 md:mb-0">
                  <div className="w-9 h-9 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-sm">
                    <Users size={20} strokeWidth={2.5} />
                  </div>
                  <span className="text-xl font-bold text-slate-900 tracking-tight">HR <span className="text-blue-600 font-black">Recruit</span></span>
                </div>
                
                {/* Tabs & Import Buttons */}
                <div className="flex items-center space-x-3 overflow-x-auto pb-1 md:pb-0 hide-scrollbar">
                  <div className="flex space-x-1 bg-slate-100/80 p-1 rounded-xl border border-slate-200/60 whitespace-nowrap">
                    <button onClick={() => setActiveTab('area_hr')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${activeTab === 'area_hr' ? 'bg-white text-blue-700 shadow-sm ring-1 ring-slate-900/5' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>
                      <Briefcase size={16} strokeWidth={activeTab === 'area_hr' ? 2.5 : 2} /><span>Area HR (ตำแหน่งงาน)</span>
                    </button>
                    <button onClick={() => setActiveTab('entry')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${activeTab === 'entry' ? 'bg-white text-blue-700 shadow-sm ring-1 ring-slate-900/5' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>
                      <UserPlus size={16} strokeWidth={activeTab === 'entry' ? 2.5 : 2} /><span>Recruit (คีย์ผู้สมัคร)</span>
                    </button>
                    <button onClick={() => setActiveTab('dashboard')} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${activeTab === 'dashboard' ? 'bg-white text-blue-700 shadow-sm ring-1 ring-slate-900/5' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>
                      <BarChart3 size={16} strokeWidth={activeTab === 'dashboard' ? 2.5 : 2} /><span>แดชบอร์ดสรุปผล</span>
                    </button>
                  </div>

                  <div className="flex items-center space-x-2">
                    {/* IMPORT POSITION CSV BUTTON */}
                    <label className="flex items-center space-x-1.5 bg-white text-slate-600 hover:bg-slate-50 hover:text-blue-600 text-xs font-bold px-3 py-2 rounded-lg transition-colors shadow-sm cursor-pointer border border-slate-200 whitespace-nowrap" title="อัปโหลดไฟล์ตำแหน่งงาน">
                      <Upload size={14} />
                      <span className="hidden sm:inline">อัปเดตตำแหน่ง (CSV)</span>
                      <input type="file" accept=".csv" className="hidden" onChange={handleImportPositionCSV} />
                    </label>

                    {/* IMPORT TA CSV BUTTON */}
                    <label className="flex items-center space-x-1.5 bg-white text-slate-600 hover:bg-slate-50 hover:text-blue-600 text-xs font-bold px-3 py-2 rounded-lg transition-colors shadow-sm cursor-pointer border border-slate-200 whitespace-nowrap" title="อัปโหลดไฟล์รายชื่อ TA">
                      <Upload size={14} />
                      <span className="hidden lg:inline">อัปเดต TA (CSV)</span>
                      <input type="file" accept=".csv" className="hidden" onChange={handleImportTACSV} />
                    </label>

                    {/* IMPORT BRANCH CSV BUTTON */}
                    <label className="flex items-center space-x-1.5 bg-white text-slate-600 hover:bg-slate-50 hover:text-blue-600 text-xs font-bold px-3 py-2 rounded-lg transition-colors shadow-sm cursor-pointer border border-slate-200 whitespace-nowrap" title="อัปโหลดไฟล์ StoreList.csv">
                      <Upload size={14} />
                      <span className="hidden lg:inline">อัปเดตสาขา (CSV)</span>
                      <input type="file" accept=".csv" className="hidden" onChange={handleImportCSV} />
                    </label>
                  </div>

                </div>
              </div>
            </div>
          </nav>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            {/* --- TAB: AREA HR --- */}
            {activeTab === 'area_hr' && (
              <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500 relative">
                
                {/* Area Select */}
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
                  <div className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                      <h2 className="text-lg font-bold text-slate-900 flex items-center space-x-2">
                        <Map className="text-blue-600" size={22} /><span>เลือกพื้นที่รับผิดชอบ (Area Selection)</span>
                      </h2>
                      <p className="text-sm text-slate-500 mt-1 ml-7">คลิกเพื่อเลือก Area ที่ต้องการจัดการ (เลือกได้มากกว่า 1)</p>
                    </div>
                    <div className="text-sm font-semibold text-blue-600 bg-blue-50 px-4 py-2 rounded-xl border border-blue-100 shadow-sm">
                      เลือกอยู่ <span className="text-lg mx-1">{selectedAreas.length}</span> Area
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                    {appAreas.map(area => {
                      const isSelected = selectedAreas.includes(area);
                      return (
                        <button 
                          key={area} 
                          onClick={() => toggleArea(area)} 
                          className={`flex items-center justify-center px-2 py-3 rounded-xl text-sm font-bold border transition-all duration-200 transform hover:scale-[1.02] active:scale-95 ${
                            isSelected 
                              ? 'bg-gradient-to-br from-blue-600 to-blue-700 text-white border-blue-600 shadow-md shadow-blue-500/30' 
                              : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:bg-blue-50/50 hover:text-blue-700 shadow-sm'
                          }`}
                        >
                          {area}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Form Add Vacancy */}
                {selectedAreas.length > 0 && (
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="bg-slate-50/50 border-b border-slate-100 px-6 py-5 flex items-center space-x-3">
                      <div className="bg-blue-100 text-blue-600 p-2 rounded-lg"><Target size={20} strokeWidth={2} /></div>
                      <h2 className="text-lg font-bold text-slate-900">เปิดตำแหน่งงานว่างใหม่</h2>
                    </div>
                    <form onSubmit={handleVacancySubmit} className="p-6 space-y-6">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-2">1. รหัส-ชื่อสาขา <span className="text-red-500">*</span></label>
                          <select required name="branchCode" value={vacancyForm.branchCode} onChange={handleVacancyInputChange} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                            <option value="">-- เลือกสาขาใน Area ที่กำหนด --</option>
                            {availableBranchesForAreas.map(b => <option key={b.code} value={b.code}>[{b.area}] {b.code} - {b.name}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-2">2. ตำแหน่งงาน <span className="text-red-500">*</span></label>
                          <select required name="position" value={vacancyForm.position} onChange={handleVacancyInputChange} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                            <option value="">-- เลือกตำแหน่งงาน --</option>
                            {appPositions.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-2">3. สถานะเริ่มต้น <span className="text-red-500">*</span></label>
                          <select required name="manualStatus" value={vacancyForm.manualStatus} onChange={handleVacancyInputChange} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                            {VACANCY_STATUSES.filter(s => s !== 'Closed').map(s => <option key={s} value={s}>{s}</option>)}
                          </select>
                        </div>
                      </div>
                      <div className="flex justify-end pt-2">
                        <button type="submit" className="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-xl shadow-sm flex items-center space-x-2 transition-colors">
                          <Briefcase size={16} /><span>บันทึกตำแหน่งงาน</span>
                        </button>
                      </div>
                    </form>
                  </div>
                )}

                {/* Table Vacancies */}
                {selectedAreas.length > 0 && (
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white flex-wrap gap-4">
                      <div>
                        <h3 className="font-bold text-slate-900 text-lg">รายการตำแหน่งงาน (Job Vacancies)</h3>
                        <p className="text-sm text-slate-500 mt-0.5">กดที่จำนวนผู้สมัครเพื่อดูรายชื่อ</p>
                      </div>
                      <div className="flex items-center space-x-3">
                        <span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-2 rounded-lg border border-slate-200">
                          ทั้งหมด <span className="text-blue-600 text-sm mx-1">{filteredVacancies.length}</span> รายการ
                        </span>
                        <button onClick={() => exportToExcel(filteredVacancies, 'Vacancies_Export')} className="flex items-center space-x-1.5 bg-emerald-50 text-emerald-700 hover:bg-emerald-600 hover:text-white border border-emerald-200 text-xs font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">
                          <Download size={14} /><span>Export Excel</span>
                        </button>
                      </div>
                    </div>
                    
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left whitespace-nowrap">
                        <thead className="bg-slate-50/80 border-b border-slate-100">
                          <tr>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs">Area / สาขา</th>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs">ตำแหน่งงาน</th>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs text-center">SLA</th>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs text-center">ผู้สมัคร</th>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs">สถานะงาน</th>
                            <th className="px-5 py-3.5 font-semibold text-slate-600 uppercase text-xs text-right">จัดการ</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {filteredVacancies.length === 0 ? (
                            <tr><td colSpan="6" className="px-6 py-12 text-center text-slate-400">ยังไม่มีข้อมูลสำหรับ Area ที่เลือก</td></tr>
                          ) : (
                            filteredVacancies.map((v) => {
                              const { applicantCount, computedStatus, slaDays, matchedApplicants } = getVacancyInsights(v.branchCode, v.position, v.manualStatus, v.createdAt);
                              const isHiringAlert = computedStatus === 'Hiring' && v.manualStatus !== 'Closed';

                              return (
                                <tr key={v.id} className={`transition-colors ${isHiringAlert ? 'bg-emerald-50/40 hover:bg-emerald-50' : 'hover:bg-slate-50/50'}`}>
                                  <td className="px-5 py-4">
                                    <div className="text-xs font-bold text-blue-600 mb-0.5">{v.area}</div>
                                    <div className="font-semibold text-slate-900">{v.branchName}</div>
                                    <div className="text-xs text-slate-400">{v.branchCode}</div>
                                  </td>
                                  <td className="px-5 py-4 text-slate-800 font-bold">{v.position}</td>
                                  
                                  <td className="px-5 py-4 text-center">
                                    <div className={`inline-flex flex-col items-center justify-center min-w-[40px] ${slaDays > 30 ? 'text-red-500' : 'text-slate-600'}`}>
                                      <span className="font-black text-base">{slaDays}</span>
                                      <span className="text-[10px] font-semibold uppercase">วัน</span>
                                    </div>
                                  </td>

                                  <td className="px-5 py-4 text-center">
                                    <button 
                                      onClick={() => setViewApplicants({ position: v.position, branchName: v.branchName, list: matchedApplicants })}
                                      disabled={applicantCount === 0}
                                      className={`inline-flex items-center justify-center min-w-[36px] h-9 rounded-xl font-bold text-sm border transition-all ${
                                        applicantCount > 0 
                                          ? 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-600 hover:text-white hover:shadow-md cursor-pointer' 
                                          : 'bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed'
                                      }`}
                                    >
                                      {applicantCount}
                                    </button>
                                  </td>

                                  <td className="px-5 py-4">
                                    <div className="flex flex-col items-start gap-1">
                                      <div className="flex items-center space-x-2">
                                        <div className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold"
                                          style={{ backgroundColor: `${VACANCY_COLORS[computedStatus] || '#475569'}15`, color: VACANCY_COLORS[computedStatus] || '#475569', border: `1px solid ${VACANCY_COLORS[computedStatus] || '#475569'}30` }}
                                        >
                                          <span className="w-1.5 h-1.5 rounded-full mr-1.5" style={{ backgroundColor: VACANCY_COLORS[computedStatus] || '#475569' }}></span>
                                          {computedStatus}
                                        </div>
                                        {isHiringAlert && <BellRing className="w-4 h-4 text-red-500 animate-bounce" />}
                                      </div>
                                    </div>
                                  </td>

                                  <td className="px-5 py-4">
                                    <div className="flex items-center justify-end space-x-2">
                                      {isHiringAlert && (
                                        <button onClick={() => closeVacancy(v.id)} className="flex items-center space-x-1 text-xs bg-red-50 text-red-600 px-2.5 py-1.5 rounded-lg border border-red-200 hover:bg-red-500 hover:text-white transition-colors shadow-sm font-semibold">
                                          <CheckCircle2 size={14} /><span>ปิดงาน</span>
                                        </button>
                                      )}
                                      <button onClick={() => setEditingVacancy(v)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                        <Edit size={16} />
                                      </button>
                                      <button onClick={() => deleteVacancy(v.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        <Trash2 size={16} />
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              );
                            })
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* --- TAB: RECRUIT ENTRY --- */}
            {activeTab === 'entry' && (
              <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                
                {/* 1. TA Selection */}
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
                  <div className="mb-6">
                    <h2 className="text-lg font-bold text-slate-900 flex items-center space-x-2"><UserPlus className="text-blue-600" size={22} /><span>ส่วนงานรับผิดชอบ (Recruiter)</span></h2>
                    <p className="text-sm text-slate-500 mt-1 ml-7">กรุณาระบุชื่อ TA ของคุณ เพื่อเรียกดูและเพิ่มผู้สมัครเข้าสู่ตำแหน่งงานที่กำลังเปิดรับ</p>
                  </div>
                  <div className="max-w-md ml-0 md:ml-7">
                    <label className="block text-sm font-semibold text-slate-700 mb-2">ชื่อผู้รับผิดชอบ (TA) <span className="text-red-500">*</span></label>
                    <select value={selectedTA} onChange={(e) => setSelectedTA(e.target.value)} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-3 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none shadow-sm">
                      <option value="">-- ระบุ TA --</option>
                      {appTAs.map(ta => <option key={ta} value={ta}>{ta}</option>)}
                    </select>
                  </div>
                </div>

                {selectedTA && (
                  <>
                    {/* 2. Vacancies List for Recruiter */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                      <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 bg-slate-50/50">
                        <div>
                          <h3 className="font-bold text-slate-900 text-lg flex items-center space-x-2">
                            <Target className="text-blue-600" size={20} />
                            <span>ตำแหน่งงานที่กำลังเปิดรับ (Active Vacancies)</span>
                          </h3>
                          <p className="text-sm text-slate-500 mt-1 ml-7">เลือก "เพิ่มผู้สมัคร" ในตำแหน่งงานที่ต้องการ</p>
                        </div>
                        
                        {/* Filters for Recruit Table */}
                        <div className="flex items-center space-x-3 w-full md:w-auto">
                          <select value={recruitAreaFilter} onChange={(e) => { setRecruitAreaFilter(e.target.value); setRecruitBranchFilter(''); }} className="w-full md:w-32 bg-white border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <option value="">ทุก Area</option>
                            {appAreas.map(area => <option key={area} value={area}>{area}</option>)}
                          </select>
                          <select value={recruitBranchFilter} onChange={(e) => setRecruitBranchFilter(e.target.value)} className="w-full md:w-48 bg-white border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-blue-500" disabled={!recruitAreaFilter}>
                            <option value="">ทุกสาขา</option>
                            {branchesForRecruitFilter.map(b => <option key={b.code} value={b.code}>{b.name}</option>)}
                          </select>
                        </div>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left whitespace-nowrap">
                          <thead className="bg-white border-b border-slate-100">
                            <tr>
                              <th className="px-6 py-3.5 font-semibold text-slate-600 uppercase text-xs">Area / สาขา</th>
                              <th className="px-6 py-3.5 font-semibold text-slate-600 uppercase text-xs">ตำแหน่งที่เปิดรับ</th>
                              <th className="px-6 py-3.5 font-semibold text-slate-600 uppercase text-xs text-center">ยอดรับสมัครแล้ว</th>
                              <th className="px-6 py-3.5 font-semibold text-slate-600 uppercase text-xs text-center">สถานะตำแหน่ง</th>
                              <th className="px-6 py-3.5 font-semibold text-slate-600 uppercase text-xs text-right">ดำเนินการ</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-50">
                            {activeVacanciesForRecruit.length === 0 ? (
                              <tr><td colSpan="5" className="px-6 py-12 text-center text-slate-400">ไม่มีตำแหน่งงานว่างที่ตรงกับเงื่อนไขการค้นหา หรือยังไม่มีการเปิดรับตำแหน่งจาก Area HR</td></tr>
                            ) : (
                              activeVacanciesForRecruit.map(v => {
                                const { applicantCount, computedStatus } = getVacancyInsights(v.branchCode, v.position, v.manualStatus, v.createdAt);
                                return (
                                  <tr key={v.id} className="hover:bg-blue-50/30 transition-colors group">
                                    <td className="px-6 py-4">
                                      <div className="text-xs font-bold text-blue-600 mb-0.5">{v.area}</div>
                                      <div className="font-semibold text-slate-900">{v.branchName}</div>
                                    </td>
                                    <td className="px-6 py-4 font-bold text-slate-800">{v.position}</td>
                                    <td className="px-6 py-4 text-center">
                                      <span className={`inline-flex items-center justify-center min-w-[32px] h-8 rounded-lg font-bold text-sm border ${applicantCount > 0 ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>
                                        {applicantCount}
                                      </span>
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                      <div className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold" style={{ backgroundColor: `${VACANCY_COLORS[computedStatus] || '#475569'}15`, color: VACANCY_COLORS[computedStatus] || '#475569', border: `1px solid ${VACANCY_COLORS[computedStatus] || '#475569'}30` }}>
                                        {computedStatus}
                                      </div>
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                      <button 
                                        onClick={() => setAddingApplicantFor(v)}
                                        className="inline-flex items-center space-x-1.5 bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-sm"
                                      >
                                        <PlusCircle size={16} />
                                        <span>เพิ่มผู้สมัคร</span>
                                      </button>
                                    </td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* 3. My Applicant History */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 mt-8">
                      <div className="px-6 py-5 border-b flex justify-between items-center flex-wrap gap-4">
                        <h3 className="font-bold text-slate-900 text-lg">ประวัติการบันทึกผู้สมัครล่าสุดของคุณ</h3>
                        <button onClick={() => exportToExcel(myApplicants, 'My_Applicants_Export')} className="flex items-center space-x-1.5 bg-emerald-50 text-emerald-700 hover:bg-emerald-600 hover:text-white border border-emerald-200 text-xs font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">
                          <Download size={14} /><span>Export Excel</span>
                        </button>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left whitespace-nowrap"><thead className="bg-slate-50"><tr><th className="px-6 py-3">สาขา</th><th className="px-6 py-3">ชื่อ-นามสกุล / ตำแหน่ง</th><th className="px-6 py-3">สถานะปัจจุบัน</th><th className="px-6 py-3">ไฟล์แนบ</th><th className="px-6 py-3 text-right">จัดการ</th></tr></thead>
                        <tbody>
                          {myApplicants.length === 0 ? (
                            <tr><td colSpan="5" className="px-6 py-8 text-center text-slate-400">คุณยังไม่มีประวัติการเพิ่มผู้สมัคร</td></tr>
                          ) : (
                            myApplicants.map(app => (
                            <tr key={app.id} className="border-t hover:bg-slate-50">
                              <td className="px-6 py-4">
                                <div className="font-semibold text-slate-800">{app.branchName}</div>
                                <div className="text-xs text-slate-400">{app.branchCode}</div>
                              </td>
                              <td className="px-6 py-4">
                                <div className="font-bold text-slate-900">{app.name}</div>
                                <div className="text-sm text-slate-600 mt-0.5">{app.position} • {app.phone}</div>
                              </td>
                              <td className="px-6 py-4">
                                <span className="px-2.5 py-1 rounded-full text-xs font-bold" style={{ backgroundColor: `${STATUS_COLORS[app.status]}15`, color: STATUS_COLORS[app.status] }}>{app.status}</span>
                                {app.comment && <div className="text-xs text-slate-500 mt-1 max-w-[200px] truncate">เหตุผล: {app.comment}</div>}
                              </td>
                              <td className="px-6 py-4">
                                {app.resumeBase64 ? (
                                  <div className="flex items-center space-x-2">
                                    <button onClick={() => setPreviewFile({ base64: app.resumeBase64, name: app.resumeName })} className="text-xs bg-blue-50 text-blue-600 px-2.5 py-1.5 rounded-md border border-blue-200 flex items-center hover:bg-blue-600 hover:text-white transition-colors shadow-sm cursor-pointer" title="ดูตัวอย่าง">
                                      <Eye size={12} className="mr-1.5"/> Preview
                                    </button>
                                  </div>
                                ) : app.resumeName ? (
                                  <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-md border flex w-fit items-center"><Paperclip size={12} className="mr-1"/> มีไฟล์</span>
                                ) : (
                                  <span className="text-xs text-slate-400">-</span>
                                )}
                              </td>
                              <td className="px-6 py-4 text-right">
                                <div className="flex items-center justify-end space-x-2">
                                  <button onClick={() => setEditingApplicant(app)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="แก้ไข"><Edit size={16} /></button>
                                  <button onClick={() => deleteApplicant(app.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="ลบ"><Trash2 size={16} /></button>
                                </div>
                              </td>
                            </tr>
                          )))}
                        </tbody></table>
                      </div>
                    </div>
                  </>
                )}

                {/* Modal: เพิ่มข้อมูลผู้สมัคร สำหรับตำแหน่งที่เลือก */}
                {addingApplicantFor && (
                  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
                      <div className="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-blue-600 text-white">
                        <div>
                          <h3 className="font-bold text-lg flex items-center space-x-2">
                            <UserPlus size={20} /><span>เพิ่มข้อมูลผู้สมัครใหม่</span>
                          </h3>
                          <p className="text-blue-100 text-sm mt-1">ตำแหน่ง: {addingApplicantFor.position} • {addingApplicantFor.branchName}</p>
                        </div>
                        <button onClick={() => setAddingApplicantFor(null)} className="p-2 text-blue-200 hover:bg-blue-500 hover:text-white rounded-full transition-colors"><X size={20} /></button>
                      </div>
                      <form onSubmit={handleRecruitSubmit} className="p-6 md:p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                          <div><label className="text-sm font-semibold mb-2 block">ชื่อ-นามสกุล <span className="text-red-500">*</span></label><input required type="text" name="name" value={formData.name} onChange={handleInputChange} className="w-full border border-slate-300 rounded-xl px-4 py-2.5 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"/></div>
                          <div><label className="text-sm font-semibold mb-2 block">เบอร์ติดต่อ <span className="text-red-500">*</span></label><input required type="tel" name="phone" value={formData.phone} onChange={handleInputChange} className="w-full border border-slate-300 rounded-xl px-4 py-2.5 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"/></div>
                          <div className="md:col-span-2">
                            <label className="text-sm font-semibold mb-2 block">สถานะผู้สมัคร <span className="text-red-500">*</span></label>
                            <select required name="status" value={formData.status} onChange={handleInputChange} className="w-full border border-slate-300 rounded-xl px-4 py-2.5 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10">
                              <option value="">-- เลือกสถานะปัจจุบัน --</option>
                              {STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                          </div>
                        </div>

                        {/* UPLOAD RESUME */}
                        <div>
                          <label className="text-sm font-semibold mb-2 block">อัปโหลดเรซูเม่ (ไม่บังคับ)</label>
                          <div className="flex items-center space-x-2">
                             <label className="flex items-center justify-center w-full bg-white border border-slate-300 border-dashed rounded-xl px-4 py-4 hover:bg-slate-50 hover:border-blue-400 cursor-pointer transition-colors shadow-sm">
                                <Upload size={18} className="text-blue-500 mr-2" />
                                <span className="text-sm text-slate-600 font-medium">{formData.resumeName || 'คลิกเพื่อเลือกไฟล์ (PDF, DOC, รูปภาพ)'}</span>
                                <input type="file" className="hidden" accept=".pdf,.doc,.docx,image/*" onChange={handleFileUpload} />
                             </label>
                             {formData.resumeName && (
                               <button type="button" onClick={() => setFormData(prev => ({...prev, resumeName:'', resumeBase64:''}))} className="p-4 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                                 <X size={20}/>
                               </button>
                             )}
                          </div>
                        </div>

                        {['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(formData.status) && (
                          <div className="bg-orange-50/50 p-5 rounded-xl border border-orange-100 animate-in fade-in duration-300">
                            <label className="text-sm font-semibold text-orange-800 mb-2 block">ระบุเหตุผล / รายละเอียด <span className="text-red-500">*</span></label>
                            <textarea required name="comment" value={formData.comment} onChange={handleInputChange} rows="2" className="w-full border border-orange-200 rounded-xl px-4 py-3 outline-none focus:border-orange-400 focus:ring-4 focus:ring-orange-500/10"></textarea>
                          </div>
                        )}
                        
                        <div className="pt-6 border-t flex justify-end space-x-3">
                          <button type="button" onClick={() => setAddingApplicantFor(null)} className="px-6 py-3 rounded-xl font-semibold text-slate-600 hover:bg-slate-100 transition-colors">ยกเลิก</button>
                          <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-xl font-semibold shadow-sm flex items-center space-x-2 transition-all active:scale-95">
                            <CheckCircle2 size={18} /><span>บันทึกข้อมูล</span>
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* --- TAB: DASHBOARD --- */}
            {activeTab === 'dashboard' && (
               <div className="space-y-8 animate-in slide-in-from-bottom-4 duration-500 pb-10">
                 <div className="bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative overflow-hidden">
                   <div className="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-white opacity-5 rounded-full blur-2xl"></div>
                   <div className="relative z-10">
                     <div className="inline-flex items-center space-x-2 bg-white/10 px-3 py-1 rounded-full text-blue-200 text-xs font-semibold mb-3 border border-white/10">
                       <span className="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></span>
                       <span>Executive Dashboard</span>
                     </div>
                     <h2 className="text-2xl md:text-3xl font-black text-white">รายงานสรุปผลสำหรับผู้บริหาร</h2>
                     <p className="text-slate-300 mt-1">ภาพรวมการสรรหาบุคลากรและประสิทธิภาพของกระบวนการ</p>
                   </div>
                   <div className="relative z-10 w-full md:w-auto">
                     <label className="block text-xs font-bold text-slate-300 mb-2 uppercase tracking-wider">วิเคราะห์ข้อมูลตาม TA</label>
                     <div className="flex items-center space-x-3 bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/20">
                       <Search size={18} className="text-slate-300 ml-3" />
                       <select value={dashboardTA} onChange={(e) => setDashboardTA(e.target.value)} className="w-full md:w-56 bg-transparent text-white py-2.5 pr-8 focus:outline-none [&>option]:text-slate-900 font-semibold cursor-pointer">
                         <option value="ALL">สรุปรวมทั้งหมด (All TAs)</option>
                         {appTAs.map(ta => <option key={ta} value={ta}>{ta}</option>)}
                       </select>
                     </div>
                   </div>
                 </div>
     
                 {/* Executive KPIs */}
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                   <div className="bg-white p-7 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:-translate-y-1 transition-transform">
                     <div className="flex justify-between items-start mb-4">
                       <div className="p-3 bg-blue-50 text-blue-600 rounded-2xl"><Users size={24} /></div>
                       <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">Total</span>
                     </div>
                     <p className="text-sm font-bold text-slate-500 mb-1">รวมผู้สมัครทั้งหมด</p>
                     <p className="text-4xl font-black text-slate-900">{dashboardData.length} <span className="text-sm font-semibold text-slate-400">คน</span></p>
                   </div>
     
                   <div className="bg-white p-7 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:-translate-y-1 transition-transform">
                     <div className="flex justify-between items-start mb-4">
                       <div className="p-3 bg-emerald-50 text-emerald-600 rounded-2xl"><CheckCircle2 size={24} /></div>
                       <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md">
                         {dashboardData.length > 0 ? Math.round((dashboardData.filter(a=>['มาเริ่มงาน','ผ่าน'].includes(a.status)).length / dashboardData.length) * 100) : 0}% Yield
                       </span>
                     </div>
                     <p className="text-sm font-bold text-slate-500 mb-1">สำเร็จ (เริ่มงาน/ผ่าน)</p>
                     <div className="flex items-baseline space-x-2">
                       <p className="text-4xl font-black text-slate-900">{dashboardData.filter(a=>['มาเริ่มงาน','ผ่าน'].includes(a.status)).length}</p>
                     </div>
                   </div>
     
                   <div className="bg-white p-7 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:-translate-y-1 transition-transform">
                     <div className="flex justify-between items-start mb-4">
                       <div className="p-3 bg-amber-50 text-amber-600 rounded-2xl"><Clock size={24} /></div>
                       <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">Pipeline</span>
                     </div>
                     <p className="text-sm font-bold text-slate-500 mb-1">รอดำเนินการ</p>
                     <p className="text-4xl font-black text-slate-900">{dashboardData.filter(a=>['รอสัมภาษณ์','รอเริ่มงาน','ตรวจสุขภาพ'].includes(a.status)).length}</p>
                   </div>
     
                   <div className="bg-white p-7 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:-translate-y-1 transition-transform">
                     <div className="flex justify-between items-start mb-4">
                       <div className="p-3 bg-red-50 text-red-600 rounded-2xl"><AlertCircle size={24} /></div>
                       <span className="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-md">
                         {dashboardData.length > 0 ? Math.round((dashboardData.filter(a=>a.status === 'ไม่ผ่าน').length / dashboardData.length) * 100) : 0}% Loss
                       </span>
                     </div>
                     <p className="text-sm font-bold text-slate-500 mb-1">ไม่ผ่านการพิจารณา</p>
                     <p className="text-4xl font-black text-slate-900">{dashboardData.filter(a=>a.status === 'ไม่ผ่าน').length}</p>
                   </div>
                 </div>
     
                 {/* Recruitment Pipeline Funnel & Charts */}
                 <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                   <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] flex flex-col">
                     <div className="mb-6 flex items-center justify-between">
                       <div>
                         <h3 className="font-bold text-lg text-slate-900">แหล่งที่มาแยกตามสาขา (Source)</h3>
                       </div>
                       <div className="p-2 bg-blue-50 text-blue-600 rounded-xl"><Building2 size={20} /></div>
                     </div>
                     <div className="flex-1 min-h-[300px]">
                       <ResponsiveContainer width="100%" height="100%">
                         <BarChart data={branchChartData} margin={{ top: 10, bottom: 0, left: -20, right: 10 }}>
                           <defs>
                             <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                               <stop offset="5%" stopColor="#3B82F6" stopOpacity={1}/>
                               <stop offset="95%" stopColor="#8B5CF6" stopOpacity={0.8}/>
                             </linearGradient>
                           </defs>
                           <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#F1F5F9" />
                           <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#64748B', fontWeight: 600}} dy={10} />
                           <YAxis axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#94A3B8', fontWeight: 500}} allowDecimals={false} />
                           <RechartsTooltip cursor={{ fill: '#F8FAFC' }} contentStyle={{ borderRadius: '12px', border: '1px solid #E2E8F0', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', fontWeight: 600 }} />
                           <Bar dataKey="count" name="จำนวน (คน)" fill="url(#colorCount)" radius={[6,6,0,0]} barSize={40} />
                         </BarChart>
                       </ResponsiveContainer>
                     </div>
                   </div>
     
                   <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] flex flex-col">
                     <div className="mb-6 flex items-center justify-between">
                       <div>
                         <h3 className="font-bold text-lg text-slate-900">อัตราส่วนสถานะผู้สมัคร (Status Mix)</h3>
                       </div>
                       <div className="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><PieChart className="w-5 h-5" /></div>
                     </div>
                     <div className="flex-1 min-h-[300px]">
                       <ResponsiveContainer width="100%" height="100%">
                         <PieChart>
                           <Pie data={statusChartData} innerRadius={80} outerRadius={115} paddingAngle={3} dataKey="value" stroke="none">
                             {statusChartData.map((e, i) => <Cell key={i} fill={STATUS_COLORS[e.name] || '#CBD5E1'} />)}
                           </Pie>
                           <RechartsTooltip contentStyle={{ borderRadius: '12px', border: '1px solid #E2E8F0', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                           <Legend layout="vertical" align="right" verticalAlign="middle" wrapperStyle={{ fontSize: '13px', color: '#475569', fontWeight: 600 }} />
                         </PieChart>
                       </ResponsiveContainer>
                     </div>
                   </div>
                   
                   {/* กราฟ SLA เพิ่มเติม */}
                   <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] flex flex-col lg:col-span-2">
                     <div className="mb-6 flex items-center justify-between">
                       <div>
                         <h3 className="font-bold text-lg text-slate-900">อายุของตำแหน่งงานว่าง (Vacancy SLA Aging)</h3>
                         <p className="text-sm text-slate-500 mt-1">จำนวนตำแหน่งงานที่ยังเปิดรับ แยกตามระยะเวลาตั้งแต่เริ่มเปิด (วัน)</p>
                       </div>
                       <div className="p-2 bg-rose-50 text-rose-600 rounded-xl"><Clock size={20} /></div>
                     </div>
                     <div className="flex-1 min-h-[300px]">
                       <ResponsiveContainer width="100%" height="100%">
                         <BarChart data={slaChartData} margin={{ top: 10, bottom: 0, left: -20, right: 10 }}>
                           <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#F1F5F9" />
                           <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#64748B', fontWeight: 600}} dy={10} />
                           <YAxis axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#94A3B8', fontWeight: 500}} allowDecimals={false} />
                           <RechartsTooltip cursor={{ fill: '#F8FAFC' }} contentStyle={{ borderRadius: '12px', border: '1px solid #E2E8F0', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', fontWeight: 600 }} />
                           <Bar dataKey="count" name="จำนวนตำแหน่ง (งาน)" radius={[6,6,0,0]} barSize={50}>
                             {slaChartData.map((entry, index) => (
                               <Cell key={`cell-${index}`} fill={entry.fill} />
                             ))}
                           </Bar>
                         </BarChart>
                       </ResponsiveContainer>
                     </div>
                   </div>

                 </div>
               </div>
            )}

            {/* Modals for Edit ... */}
            {editingVacancy && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-blue-50 text-blue-900">
                    <h3 className="font-bold text-lg flex items-center space-x-2"><Edit size={18} /><span>แก้ไขตำแหน่งงานว่าง</span></h3>
                    <button onClick={() => setEditingVacancy(null)} className="p-2 text-blue-400 hover:bg-blue-100 hover:text-blue-600 rounded-full"><X size={20} /></button>
                  </div>
                  <form onSubmit={submitEditVacancy} className="p-6 space-y-5">
                    <div>
                      <label className="block text-sm font-semibold text-slate-700 mb-2">สาขา</label>
                      <select required value={editingVacancy.branchCode} onChange={(e) => setEditingVacancy({...editingVacancy, branchCode: e.target.value})} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                        {availableBranchesForAreas.map(b => <option key={b.code} value={b.code}>[{b.area}] {b.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-slate-700 mb-2">ตำแหน่งงาน</label>
                      <select required value={editingVacancy.position} onChange={(e) => setEditingVacancy({...editingVacancy, position: e.target.value})} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                        <option value="">-- เลือกตำแหน่งงาน --</option>
                        {appPositions.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-slate-700 mb-2">สถานะการทำงาน</label>
                      <select required value={editingVacancy.manualStatus} onChange={(e) => setEditingVacancy({...editingVacancy, manualStatus: e.target.value})} className="w-full bg-white border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-blue-500/10 focus:border-blue-500 outline-none">
                        {VACANCY_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    <div className="flex justify-end pt-4 space-x-3">
                      <button type="button" onClick={() => setEditingVacancy(null)} className="px-5 py-2.5 rounded-xl font-semibold text-slate-600 hover:bg-slate-100">ยกเลิก</button>
                      <button type="submit" className="px-5 py-2.5 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {editingApplicant && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-blue-50 text-blue-900">
                    <h3 className="font-bold text-lg flex items-center space-x-2"><Edit size={18} /><span>แก้ไขข้อมูลผู้สมัคร</span></h3>
                    <button onClick={() => setEditingApplicant(null)} className="p-2 text-blue-400 hover:bg-blue-100 hover:text-blue-600 rounded-full"><X size={20} /></button>
                  </div>
                  <form onSubmit={submitEditApplicant} className="p-6 space-y-5">
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-semibold mb-2">ชื่อ-นามสกุล</label><input required type="text" value={editingApplicant.name} onChange={(e) => setEditingApplicant({...editingApplicant, name: e.target.value})} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500" /></div>
                        <div><label className="block text-sm font-semibold mb-2">เบอร์ติดต่อ</label><input required type="tel" value={editingApplicant.phone} onChange={(e) => setEditingApplicant({...editingApplicant, phone: e.target.value})} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500" /></div>
                    </div>
                    <div>
                        <label className="block text-sm font-semibold mb-2">ตำแหน่งงาน</label>
                        <select required value={editingApplicant.position} onChange={(e) => setEditingApplicant({...editingApplicant, position: e.target.value})} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500" disabled>
                          <option value="">{editingApplicant.position}</option>
                        </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-2">สถานะผู้สมัคร</label>
                      <select required value={editingApplicant.status} onChange={(e) => setEditingApplicant({...editingApplicant, status: e.target.value})} className="w-full border rounded-xl px-4 py-2.5 outline-none focus:border-blue-500">
                        {STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    {['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(editingApplicant.status) && (
                      <div><label className="block text-sm font-semibold text-orange-800 mb-2">ระบุเหตุผล <span className="text-red-500">*</span></label><textarea required value={editingApplicant.comment || ''} onChange={(e) => setEditingApplicant({...editingApplicant, comment: e.target.value})} rows="2" className="w-full border border-orange-300 rounded-xl px-4 py-2.5 outline-none focus:border-orange-500"></textarea></div>
                    )}
                    <div className="flex justify-end pt-4 space-x-3">
                      <button type="button" onClick={() => setEditingApplicant(null)} className="px-5 py-2.5 rounded-xl font-semibold text-slate-600 hover:bg-slate-100">ยกเลิก</button>
                      <button type="submit" className="px-5 py-2.5 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm">บันทึก</button>
                    </div>
                  </form>
                </div>
              </div>
            )}
            
            {/* Modal: View Applicants (Popup รายชื่อผู้สมัครเมื่อกดจากตาราง Area HR) */}
            {viewApplicants && (
               <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
                 <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
                   <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                     <div>
                       <h3 className="font-bold text-lg text-slate-900">ผู้สมัคร: {viewApplicants.position}</h3>
                       <p className="text-sm text-slate-500">{viewApplicants.branchName}</p>
                     </div>
                     <button onClick={() => setViewApplicants(null)} className="p-2 text-slate-400 hover:bg-slate-200 rounded-full transition-colors"><X size={20} /></button>
                   </div>
                   <div className="p-6 max-h-[60vh] overflow-y-auto">
                     <div className="space-y-3">
                       {viewApplicants.list.map(app => (
                         <div key={app.id} className="p-4 rounded-xl border border-slate-100 flex justify-between items-center hover:border-blue-200 transition-colors">
                           <div className="flex items-start space-x-3">
                             <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold shrink-0">{app.name.charAt(0)}</div>
                             <div>
                               <p className="font-bold text-slate-900">{app.name}</p>
                               <div className="flex flex-wrap items-center gap-2 mt-1">
                                 <p className="text-sm text-slate-500 flex items-center"><Phone size={12} className="mr-1"/> {app.phone}</p>
                                 
                                 {/* เพิ่มปุ่ม Preview หรือสถานะไฟล์แนบ ตรงนี้ครับ */}
                                 {app.resumeBase64 && (
                                   <button 
                                     onClick={() => setPreviewFile({ base64: app.resumeBase64, name: app.resumeName })}
                                     className="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-md border border-blue-200 flex items-center hover:bg-blue-600 hover:text-white transition-colors"
                                     title="ดูตัวอย่างเรซูเม่"
                                   >
                                     <Eye size={12} className="mr-1"/> เรซูเม่
                                   </button>
                                 )}
                               </div>
                             </div>
                           </div>
                           <div className="text-right shrink-0">
                             <span className="inline-block px-2.5 py-1 rounded-full text-xs font-bold" style={{ backgroundColor: `${STATUS_COLORS[app.status]}15`, color: STATUS_COLORS[app.status] }}>{app.status}</span>
                             <p className="text-[10px] text-slate-400 mt-1">โดย {app.ta}</p>
                           </div>
                         </div>
                       ))}
                     </div>
                   </div>
                 </div>
               </div>
             )}

            {/* Modal: Preview File (แสดงไฟล์เรซูเม่) */}
            {previewFile && (
              <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <div>
                      <h3 className="font-bold text-lg text-slate-900 flex items-center space-x-2">
                        <Eye size={20} className="text-blue-500" />
                        <span>ตัวอย่างไฟล์เอกสาร</span>
                      </h3>
                      <p className="text-sm text-slate-500 mt-0.5">{previewFile.name}</p>
                    </div>
                    <div className="flex items-center space-x-2">
                      <a 
                        href={previewFile.base64} 
                        download={previewFile.name} 
                        className="flex items-center space-x-1.5 px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white rounded-xl transition-colors font-semibold shadow-sm text-sm"
                      >
                        <Download size={16} /><span>ดาวน์โหลด</span>
                      </a>
                      <button onClick={() => setPreviewFile(null)} className="p-2 text-slate-400 hover:bg-slate-200 hover:text-slate-700 rounded-full transition-colors"><X size={20} /></button>
                    </div>
                  </div>
                  
                  <div className="flex-1 bg-slate-100 p-4 sm:p-6 flex items-center justify-center overflow-hidden">
                    {previewFile.base64.startsWith('data:application/pdf') || previewFile.base64.startsWith('data:image/') ? (
                      <iframe 
                        src={previewFile.base64} 
                        className="w-full h-full rounded-xl border border-slate-200 shadow-sm bg-white" 
                        title="File Preview"
                      ></iframe>
                    ) : (
                      <div className="text-center bg-white p-12 rounded-2xl shadow-sm border border-slate-200 max-w-sm">
                        <div className="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-6">
                          <FileText size={40} className="text-orange-400" />
                        </div>
                        <p className="text-lg font-bold text-slate-800 mb-2">ไม่สามารถแสดงตัวอย่างไฟล์ได้</p>
                        <p className="text-sm text-slate-500 mb-6">ไฟล์ประเภท Word (doc, docx) หรือไฟล์อื่นๆ จำเป็นต้องดาวน์โหลดเพื่อเปิดดูในเครื่องของคุณครับ</p>
                        <a 
                          href={previewFile.base64} 
                          download={previewFile.name} 
                          className="inline-flex items-center justify-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors font-semibold shadow-sm w-full"
                        >
                          <Download size={18} /><span>ดาวน์โหลดไฟล์</span>
                        </a>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

          </main>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
