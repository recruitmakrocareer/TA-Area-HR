<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HR Recruitment Workspace</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS for Excel/CSV Parsing and Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Custom Select for Badges */
    .status-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.4rem center;
      background-size: 1em;
      padding-right: 1.6rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React Code -->
  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';
    import { Users, UserPlus, BarChart3, Building2, CheckCircle2, Clock, MapPin, Search, AlertCircle, FileText, Briefcase, Phone, MessageSquare, Map, Target, Edit, Trash2, X, BellRing, Download, Paperclip, Upload, Eye, PlusCircle, Settings, Check } from 'https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0';

    // ==========================================
    // ⚙️ การตั้งค่า GOOGLE SHEETS API
    // ==========================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzM4EXsW141-nqY7rRwU_MFc9vnrJSbK-8Wdwn-ZJwvfEBlNMZJH2dhE0r2C4uJf7mnxg/exec"; 

    // --- MOCK DATA ---
    const DEFAULT_TAS = ['TA 1 (คุณเอ)', 'TA 2 (คุณบี)', 'TA 3 (คุณซี)', 'TA 4 (คุณดี)'];
    const DEFAULT_POSITIONS = [
      { position: 'ผู้จัดการสาขา', recruit: '', area: '' },
      { position: 'ผู้ช่วยผู้จัดการสาขา', recruit: '', area: '' },
      { position: 'พนักงานขาย', recruit: '', area: '' },
      { position: 'พนักงานแคชเชียร์', recruit: '', area: '' },
      { position: 'พนักงานจัดเรียงสินค้า', recruit: '', area: '' },
      { position: 'พนักงานธุรการ', recruit: '', area: '' },
      { position: 'บัญชี', recruit: '', area: '' }
    ];

    const DEFAULT_BRANCHES = [
      { code: '001', name: 'สาขาลาดพร้าว', area: 'Area 5' },
      { code: '002', name: 'สาขาแจ้งวัฒนะ', area: 'Area 10' },
      { code: '003', name: 'สาขาศรีนครินทร์', area: 'Area 11' },
      { code: '004', name: 'สาขาบางบอน', area: 'Area 1' },
      { code: '005', name: 'สาขาชลบุรี', area: 'Area 9' },
      { code: '006', name: 'สาขาเชียงใหม่ 1 (ตลาดเมืองใหม่)', area: 'Area 6' },
      { code: '007', name: 'สาขานครราชสีมา', area: 'Area 2' },
      { code: '008', name: 'สาขารังสิต', area: 'Area 11' },
      { code: '009', name: 'สาขาหาดใหญ่', area: 'Area 4' },
      { code: '010', name: 'สาขาอุดรธานี', area: 'Area 7' },
      { code: '011', name: 'สาขาพิษณุโลก', area: 'Area 2' },
      { code: '012', name: 'สาขาขอนแก่น', area: 'Area 7' },
      { code: '013', name: 'สาขาสุราษฏร์ธานี', area: 'Area 4' },
      { code: '014', name: 'สาขาอุบลราชธานี', area: 'Area 8' },
      { code: '015', name: 'สาขาระยอง', area: 'Area 14' },
      { code: '016', name: 'สาขานครสวรรค์', area: 'Area 2' },
      { code: '017', name: 'สาขาจรัญสนิทวงศ์', area: 'Area 10' },
      { code: '018', name: 'สาขาสาทร', area: 'Area 13' },
      { code: '019', name: 'สาขานครปฐม', area: 'Area 5' },
      { code: '020', name: 'สาขาสุรินทร์', area: 'Area 8' },
      { code: '021', name: 'สาขาสามเสน', area: 'Area 13' },
      { code: '022', name: 'สาขานครศรีธรรมราช', area: 'Area 4' },
      { code: '023', name: 'สาขาเชียงราย', area: 'Area 6' },
      { code: '122', name: 'สาขาประชาอุทิศ', area: 'Area 3' }
    ];

    const STATUSES = ['รอสัมภาษณ์', 'ไม่เข้าสัมภาษณ์', 'ผ่าน', 'ไม่ผ่าน', 'สำรอง', 'ตรวจสุขภาพ', 'รอเริ่มงาน', 'มาเริ่มงาน', 'ไม่มาเริ่มงาน', 'อื่นๆ'];
    const VACANCY_STATUSES = ['Vacant', 'Promote&Transfer', 'Hold', 'Closed'];

    const STATUS_COLORS = { 'รอสัมภาษณ์': '#F59E0B', 'ไม่เข้าสัมภาษณ์': '#64748B', 'ผ่าน': '#10B981', 'ไม่ผ่าน': '#EF4444', 'สำรอง': '#3B82F6', 'ตรวจสุขภาพ': '#8B5CF6', 'รอเริ่มงาน': '#0EA5E9', 'มาเริ่มงาน': '#059669', 'ไม่มาเริ่มงาน': '#94A3B8', 'อื่นๆ': '#F97316' };
    const VACANCY_COLORS = { 'Vacant': '#F59E0B', 'Promote&Transfer': '#8B5CF6', 'Hold': '#64748B', 'Closed': '#94A3B8', 'รอตรวจสุขภาพ': '#0EA5E9', 'รอเริ่มงาน': '#0EA5E9', 'Hiring': '#10B981' };

    // --- HELPER FUNCTION: ตัวแปลงวันที่ขั้นเทพ (แก้ปัญหา SLA ไม่ขึ้น) ---
    const parseDateToMs = (val) => {
      if (!val) return null;
      let cleanStr = String(val).replace(/,/g, '').trim();
      let num = Number(cleanStr);
      if (!isNaN(num) && num > 1000000000000) return num;
      if (!isNaN(num) && num > 30000 && num < 100000) return new Date(Math.round((num - 25569) * 86400 * 1000)).getTime();
      let d = new Date(val);
      if (!isNaN(d.getTime())) return d.getTime();
      if (typeof val === 'string' && (val.includes('/') || val.includes('-'))) {
        let datePart = val.split(' ')[0];
        let parts = datePart.includes('/') ? datePart.split('/') : datePart.split('-');
        if (parts.length >= 2) {
          let p1 = parseInt(parts[0], 10);
          let p2 = parseInt(parts[1], 10);
          let p3 = parts.length === 3 ? parseInt(parts[2], 10) : new Date().getFullYear();
          let day = p1, month = p2 - 1, year = p3;
          if (p1 > 1000) { year = p1; month = p2 - 1; day = parts.length === 3 ? parseInt(parts[2], 10) : 1; }
          if (year > 2500) year -= 543; 
          if (year >= 2000) { 
             let d2 = new Date(year, month, day);
             if (!isNaN(d2.getTime())) return d2.getTime();
          }
        }
      }
      return null;
    };

    // --- HELPER FUNCTION: ฟอร์แมตเวลาบันทึกข้อมูล (แก้ปัญหา Timestamp หน้าตาไม่เหมือนกันในชีต) ---
    const getConsistentTimestamp = () => {
      const d = new Date();
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear(); // ใช้ ค.ศ. เสมอ เพื่อให้ Sheets เข้าใจง่าย
      const hrs = String(d.getHours()).padStart(2, '0');
      const mins = String(d.getMinutes()).padStart(2, '0');
      const secs = String(d.getSeconds()).padStart(2, '0');
      return `${day}/${month}/${year} ${hrs}:${mins}:${secs}`;
    };

    function App() {
      const [activeTab, setActiveTab] = useState('area_hr');
      const [isLoading, setIsLoading] = useState(true); 
      const [cloudStatus, setCloudStatus] = useState('loading'); 
      
      const [appBranches, setAppBranches] = useState([]);
      const [appAreas, setAppAreas] = useState([]);
      const [appTAs, setAppTAs] = useState([]);
      const [appPositions, setAppPositions] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [selectedTA, setSelectedTA] = useState('');
      const [recruitAreaFilter, setRecruitAreaFilter] = useState('');
      const [recruitBranchFilter, setRecruitBranchFilter] = useState('');
      const [addingApplicantFor, setAddingApplicantFor] = useState(null);
      const [formData, setFormData] = useState({ name: '', phone: '', status: '', comment: '', startDate: '', resumeName: '', resumeBase64: '' });
      const [applicants, setApplicants] = useState([]);
      const [editAppId, setEditAppId] = useState(null);
      const [editAppForm, setEditAppForm] = useState({});
      const [previewFile, setPreviewFile] = useState(null);
      const [selectedAreas, setSelectedAreas] = useState([]);
      const [vacancyForm, setVacancyForm] = useState({ branchCode: '', position: '', manualStatus: 'Vacant' });
      const [viewApplicants, setViewApplicants] = useState(null);
      const [vacancies, setVacancies] = useState([]);
      const [editVacId, setEditVacId] = useState(null);
      const [editVacForm, setEditVacForm] = useState({});
      const [dashboardTA, setDashboardTA] = useState('ALL');

      const uniquePositionNames = useMemo(() => {
        return [...new Set(appPositions.map(p => p.position))];
      }, [appPositions]);

      useEffect(() => {
        const normalizePositions = (positions) => {
          return positions.map(p => {
            if (typeof p === 'string') return { position: p, recruit: '', area: '' };
            return { 
              position: String(p.position || p.name || '').trim(), 
              recruit: String(p.recruit || '').trim(),
              area: String(p.area || '').trim() 
            };
          });
        };

        const initLoad = async () => {
          setIsLoading(true);
          setCloudStatus('loading');
          
          let isCloudSuccess = false;
          let loadedApps = [];
          let loadedVacs = [];

          try {
            if (GOOGLE_SCRIPT_URL) {
              const res = await fetch(`${GOOGLE_SCRIPT_URL}?t=${new Date().getTime()}`);
              const data = await res.json();
              isCloudSuccess = true;
              setCloudStatus('connected');
              
              if (data.applicants) {
                loadedApps = data.applicants.map(a => ({...a, id: String(a.id), branchCode: String(a.branchCode).padStart(3, '0')}));
              }
              if (data.vacancies) {
                loadedVacs = data.vacancies.map(v => ({...v, id: String(v.id), branchCode: String(v.branchCode).padStart(3, '0')}));
              }

              if (data.branches && data.branches.length > 0) setAppBranches(data.branches.map(b => ({...b, code: String(b.code).padStart(3, '0')})));
              else setAppBranches(DEFAULT_BRANCHES);
              
              if (data.tas && data.tas.length > 0) setAppTAs(data.tas.map(t => String(t.name || t)));
              else setAppTAs(DEFAULT_TAS);
              
              if (data.positions && data.positions.length > 0) setAppPositions(normalizePositions(data.positions));
              else setAppPositions(DEFAULT_POSITIONS);
            }
          } catch (e) {
            console.error("ดึงข้อมูลจาก Cloud ไม่สำเร็จ, ใช้ข้อมูลสำรองในเครื่อง", e);
            setCloudStatus('error');
            
            let localApps = localStorage.getItem('hr_applicants');
            let localVacs = localStorage.getItem('hr_vacancies');
            
            if (localApps) loadedApps = JSON.parse(localApps);
            if (localVacs) loadedVacs = JSON.parse(localVacs);
            
            const localBranches = localStorage.getItem('hr_branches');
            if (localBranches) { try { setAppBranches(JSON.parse(localBranches)); } catch(err) {} }
            else setAppBranches(DEFAULT_BRANCHES);
            
            const localTAs = localStorage.getItem('hr_tas');
            if (localTAs) { try { setAppTAs(JSON.parse(localTAs)); } catch(e) {} }
            else setAppTAs(DEFAULT_TAS);

            const localPositions = localStorage.getItem('hr_positions');
            if (localPositions) { 
              try { setAppPositions(normalizePositions(JSON.parse(localPositions))); } catch(e) {} 
            }
            else setAppPositions(DEFAULT_POSITIONS);
          }

          let needsAutoSync = false;
          const today = new Date();
          today.setHours(0,0,0,0);
          
          loadedApps = loadedApps.map(a => {
            if (a.status === 'รอเริ่มงาน' && a.startDate) {
              const sDate = new Date(a.startDate);
              sDate.setHours(0,0,0,0);
              if (sDate <= today) {
                needsAutoSync = true;
                return { ...a, status: 'มาเริ่มงาน' };
              }
            }
            return a;
          });

          setApplicants(loadedApps);
          setVacancies(loadedVacs);
          setIsLoading(false);

          if (needsAutoSync && isCloudSuccess) {
            syncToCloud(loadedApps, loadedVacs, true);
          }
        };
        
        initLoad();
      }, []);

      useEffect(() => {
        if (appBranches.length > 0) {
          const uniqueAreas = [...new Set(appBranches.map(b => String(b.area)))].sort((a,b) => {
            const numA = parseInt(a.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.replace(/\D/g, '')) || 0;
            return numA - numB;
          });
          setAppAreas(uniqueAreas);
        }
      }, [appBranches]);

      const syncToCloud = async (newApps, newVacs, forceSync = false) => {
        localStorage.setItem('hr_applicants', JSON.stringify(newApps));
        localStorage.setItem('hr_vacancies', JSON.stringify(newVacs));
        
        const isSafeToSync = forceSync || cloudStatus === 'connected' || cloudStatus === 'syncing';

        if (!isSafeToSync) {
            alert('⚠️ [คำเตือน] ขณะนี้คุณอยู่ใน "โหมดออฟไลน์"\nระบบจะบันทึกข้อมูลไว้ในเครื่องชั่วคราวเท่านั้น แต่จะไม่ถูกส่งขึ้นส่วนกลาง เพื่อป้องกันการลบทับข้อมูลของเพื่อนร่วมงานครับ\n\n(กรุณารีเฟรชหน้าจอใหม่เมื่ออินเทอร์เน็ตพร้อมใช้งาน)');
            return;
        }

        if (GOOGLE_SCRIPT_URL) {
          try {
            setCloudStatus('syncing');
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'saveAll', applicants: newApps, vacancies: newVacs })
            });
            setTimeout(() => setCloudStatus('connected'), 1000);
          } catch (error) {
            console.error('Sync Error:', error);
            setCloudStatus('error');
          }
        }
      };

      const syncMasterToCloud = async (newBranches, newTAs, newPositions) => {
        if (cloudStatus === 'error') {
            alert('❌ ไม่สามารถอัปเดตไฟล์ Master ได้ เนื่องจากคุณอยู่ในโหมดออฟไลน์');
            return;
        }

        setIsLoading(true);
        setCloudStatus('syncing');
        if (GOOGLE_SCRIPT_URL) {
          try {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ 
                action: 'updateMaster', 
                branches: newBranches, 
                tas: newTAs.map(name => ({name})), 
                positions: newPositions 
              })
            });
            setCloudStatus('connected');
            alert('อัปเดตข้อมูล Master Data ขึ้นระบบส่วนกลางสำเร็จ!');
          } catch (error) {
            console.error('Sync Master Error:', error);
            setCloudStatus('error');
            alert('อัปเดตข้อมูลไม่สำเร็จ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
          }
        }
        setIsLoading(false);
      };

      const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newBranches = [];
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0] && row[1] && row[2]) {
                const code = String(row[0]).padStart(3, '0');
                const name = String(row[1]).replace(/\n/g, ' ').replace(/\r/g, '').trim();
                const area = String(row[2]).replace(/\r/g, '').trim();
                newBranches.push({ code, name, area });
              }
            }

            if (newBranches.length > 0) {
              setAppBranches(newBranches);
              localStorage.setItem('hr_branches', JSON.stringify(newBranches));
              syncMasterToCloud(newBranches, appTAs, appPositions);
            } else {
              alert('ไม่พบข้อมูลในไฟล์ หรือรูปแบบคอลัมน์ไม่ถูกต้อง (ต้องมี Store No., Location Name, Area No.)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV สาขา');
          }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportPositionCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newPositions = [];
            const newTAsSet = new Set(appTAs);
            let foundNewTA = false;

            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0]) {
                const posName = String(row[0]).replace(/\r/g, '').trim();
                const recruitName = row[1] ? String(row[1]).replace(/\r/g, '').trim() : '';
                const areaName = row[2] ? String(row[2]).replace(/\r/g, '').trim() : '';
                
                if (posName) {
                  newPositions.push({ position: posName, recruit: recruitName, area: areaName });
                  if (recruitName && !newTAsSet.has(recruitName)) {
                    newTAsSet.add(recruitName);
                    foundNewTA = true;
                  }
                }
              }
            }

            if (newPositions.length > 0) {
              setAppPositions(newPositions);
              localStorage.setItem('hr_positions', JSON.stringify(newPositions));
              
              const updatedTAs = Array.from(newTAsSet);
              if (foundNewTA) {
                setAppTAs(updatedTAs);
                localStorage.setItem('hr_tas', JSON.stringify(updatedTAs));
              }
              
              syncMasterToCloud(appBranches, updatedTAs, newPositions);
              
              if (foundNewTA) {
                alert(`อัปเดตตำแหน่งงานสำเร็จ!\n- นำเข้าตำแหน่งและเงื่อนไข Area ทั้งหมด ${newPositions.length} รายการ\n- อัปเดตรายชื่อ TA ให้อัตโนมัติ (พบรายชื่อใหม่)`);
              } else {
                alert(`อัปเดตตำแหน่งงานและผู้รับผิดชอบสำเร็จ! นำเข้าทั้งหมด ${newPositions.length} รายการ`);
              }
            } else {
              alert('ไม่พบข้อมูลในไฟล์ (ข้อมูลตำแหน่งงานต้องอยู่ในคอลัมน์แรกสุด)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV ตำแหน่งงาน');
          }
        };
        reader.readAsBinaryString(file);
      };

      const handleImportTACSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const wsname = wb.SheetNames[0];
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname], { header: 1 });
            
            const newTAs = [];
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              if (row && row[0]) {
                const taName = String(row[0]).replace(/\r/g, '').trim();
                if (taName) newTAs.push(taName);
              }
            }

            if (newTAs.length > 0) {
              setAppTAs(newTAs);
              localStorage.setItem('hr_tas', JSON.stringify(newTAs));
              syncMasterToCloud(appBranches, newTAs, appPositions);
            } else {
              alert('ไม่พบข้อมูลในไฟล์ (ข้อมูลชื่อ TA ต้องอยู่ในคอลัมน์แรกสุด)');
            }
          } catch (err) {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV รายชื่อ TA');
          }
        };
        reader.readAsBinaryString(file);
      };

      const exportToExcel = (dataList, filename) => {
        const worksheet = XLSX.utils.json_to_sheet(dataList);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
        XLSX.writeFile(workbook, `${filename}.xlsx`);
      };

      const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
      
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setFormData(prev => ({ ...prev, resumeBase64: reader.result, resumeName: file.name }));
          };
          reader.readAsDataURL(file);
        }
      };
      
      const handleRecruitSubmit = async (e) => {
        e.preventDefault();
        if (!selectedTA || !addingApplicantFor) return;
        
        if (formData.status === 'รอเริ่มงาน' && !formData.startDate) {
          alert('กรุณาระบุวันที่เริ่มงาน');
          return;
        }
        
        const newRecord = { 
          id: Date.now().toString(), 
          ta: selectedTA, 
          branchCode: String(addingApplicantFor.branchCode).padStart(3, '0'), 
          branchName: addingApplicantFor.branchName, 
          position: addingApplicantFor.position,
          ...formData, 
          timestamp: getConsistentTimestamp(), // เปลี่ยนมาใช้ตัวฟอร์แมตเวลามาตรฐาน
          updatedAt: Date.now() 
        };
        
        const newApps = [newRecord, ...applicants];
        setApplicants(newApps);
        setFormData({ name: '', phone: '', status: '', comment: '', startDate: '', resumeName: '', resumeBase64: '' });
        setAddingApplicantFor(null);
        
        syncToCloud(newApps, vacancies);
      };

      const deleteApplicant = (id) => {
        if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลผู้สมัครรายนี้?')) {
          const newApps = applicants.filter(a => String(a.id) !== String(id));
          setApplicants(newApps);
          syncToCloud(newApps, vacancies);
        }
      };

      const startEditApp = (app) => {
        setEditAppId(app.id);
        setEditAppForm({ ...app });
      };

      const saveEditApp = () => {
        if (['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(editAppForm.status) && !editAppForm.comment) {
          alert('กรุณาระบุเหตุผลในช่องที่กำหนด');
          return;
        }
        if (editAppForm.status === 'รอเริ่มงาน' && !editAppForm.startDate) {
          alert('กรุณาระบุวันที่เริ่มงาน');
          return;
        }
        
        if (!['อื่นๆ', 'ไม่ผ่าน', 'ไม่มาเริ่มงาน'].includes(editAppForm.status)) {
          editAppForm.comment = '';
        }

        const newApps = applicants.map(a => String(a.id) === String(editAppId) ? { ...editAppForm, updatedAt:
